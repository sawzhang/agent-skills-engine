# SkillKit æŠ€æœ¯æ¶æ„å…¨æ™¯æ–‡æ¡£

> **Skills are new software. CLIs are new API. Agents are new OS.**
> **Multi-modal is new UI. Vibe coding is new product management.**

---

## ç›®å½•

1. [è®¾è®¡å“²å­¦ï¼šSkill First](#1-è®¾è®¡å“²å­¦skill-first)
2. [æ•´ä½“æ¶æ„æ¦‚è§ˆ](#2-æ•´ä½“æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒä½“ç³»è¯¦è§£](#3-æ ¸å¿ƒä½“ç³»è¯¦è§£)
   - [3.1 Skills æŠ€èƒ½ä½“ç³»](#31-skills-æŠ€èƒ½ä½“ç³»)
   - [3.2 Agent ä»£ç†ä½“ç³»](#32-agent-ä»£ç†ä½“ç³»)
   - [3.3 Tools å·¥å…·ä½“ç³»](#33-tools-å·¥å…·ä½“ç³»)
   - [3.4 Memory è®°å¿†ä½“ç³»](#34-memory-è®°å¿†ä½“ç³»)
   - [3.5 MCP / Extensions æ‰©å±•ä½“ç³»](#35-mcp--extensions-æ‰©å±•ä½“ç³»)
4. [æ”¯æ’‘ä½“ç³»](#4-æ”¯æ’‘ä½“ç³»)
   - [4.1 äº‹ä»¶æ€»çº¿ä¸ Hooks (EventBus)](#41-äº‹ä»¶æ€»çº¿ä¸-hooks-eventbus)
   - [4.2 ä¸Šä¸‹æ–‡ç®¡ç† (ContextManager)](#42-ä¸Šä¸‹æ–‡ç®¡ç†-contextmanager)
   - [4.3 ä¼šè¯æŒä¹…åŒ– (Session)](#43-ä¼šè¯æŒä¹…åŒ–-session)
   - [4.4 åŒ…ç®¡ç† (Packages)](#44-åŒ…ç®¡ç†-packages)
   - [4.5 è·¨æ¨¡å‹é€‚é… (Adapters)](#45-è·¨æ¨¡å‹é€‚é…-adapters)
   - [4.6 TUI ç»ˆç«¯ç•Œé¢ä½“ç³»](#46-tui-ç»ˆç«¯ç•Œé¢ä½“ç³»)
   - [4.7 Prompt Caching ç¼“å­˜ç­–ç•¥](#47-prompt-caching-ç¼“å­˜ç­–ç•¥)
5. [å®Œæ•´æ‰§è¡Œæµç¨‹ï¼šSkill çš„åŠ¨æ€åŠ è½½ä¸è¿è¡Œ](#5-å®Œæ•´æ‰§è¡Œæµç¨‹skill-çš„åŠ¨æ€åŠ è½½ä¸è¿è¡Œ)
6. [é¡¹ç›®äº®ç‚¹ä¸åˆ›æ–°åˆ†æ](#6-é¡¹ç›®äº®ç‚¹ä¸åˆ›æ–°åˆ†æ)
7. [ä¸å…¶ä»– Agent å“²å­¦çš„å¯¹æ¯”](#7-ä¸å…¶ä»–-agent-å“²å­¦çš„å¯¹æ¯”)
8. [å­¦ä¹ è·¯çº¿å›¾](#8-å­¦ä¹ è·¯çº¿å›¾)

---

## 1. è®¾è®¡å“²å­¦ï¼šSkill First

### 1.1 å››å¤§ Agent å“²å­¦

å½“å‰ Agent é¢†åŸŸå­˜åœ¨å››ç§ä¸»æµè®¾è®¡å“²å­¦ï¼š

| å“²å­¦ç±»å‹ | ä»£è¡¨æ¡†æ¶ | æ ¸å¿ƒç‰¹ç‚¹ | Agent è‡ªä¸»æ€§ | å…¸å‹åœºæ™¯ |
|---------|---------|---------|-------------|---------|
| **Tool First**ï¼ˆå·¥å…·ä¼˜å…ˆï¼‰ | LangChain, Semantic Kernel | ç»™ agent å¤§é‡å·¥å…·ï¼Œprompt é‡Œå†™ "use these tools when appropriate"ï¼Œæ¨¡å‹è‡ªç”±é€‰æ‹©è°ƒç”¨é¡ºåº | ä¸­é«˜ï¼ˆæ¨¡å‹è‡ªç”±é€‰å·¥å…·/é¡ºåºï¼Œä½†æ˜“æ··ä¹±ï¼‰ | æ¢ç´¢æ€§ä»»åŠ¡ã€RAG + tool æ··åˆï¼Œä½†å®¹æ˜“ token çˆ†ç‚¸ã€æ¨¡å‹é€‰é”™å·¥å…· |
| **Workflow First**ï¼ˆå·¥ä½œæµä¼˜å…ˆï¼‰ | LangGraph, CrewAI, n8n + AI nodes, Power Automate | æŠŠ agent ä»»åŠ¡å»ºæ¨¡æˆ graph / DAG / è§’è‰²å›¢é˜Ÿ / å›ºå®š SOPï¼Œæ­¥éª¤æ˜ç¡®ã€å¯è§†åŒ–ã€å¯æ§ã€æ˜“å®¡è®¡ | ä½â†’ä¸­ï¼ˆåä½ï¼Œå›¾/è§’è‰²é™åˆ¶å¼ºï¼‰ | ç”Ÿäº§çº§ã€ä¼ä¸šåœºæ™¯ã€éœ€è¦å¯é æ€§/å¯è§‚æµ‹æ€§/æˆæœ¬æ§åˆ¶æ—¶é¦–é€‰ |
| **Skill First**ï¼ˆæŠ€èƒ½/æ‰©å±•ä¼˜å…ˆï¼‰ | **SkillKit**, pi-mono/Pi, nanoclaw å˜ä½“ | åªç»™æå°‘åŸè¯­å·¥å…·ï¼ˆ4 ä¸ªï¼‰ï¼Œæ‰€æœ‰é«˜çº§èƒ½åŠ›å¤–åŒ…ç»™ skill æ–‡ä»¶/æ‰©å±•ï¼Œprompt æçŸ­ï¼Œé  caching + æ¨¡å‹æ¨ç† | **é«˜**ï¼ˆè£¸ ReAct loopï¼Œå‡ ä¹å®Œå…¨é æ¨¡å‹è‡ªå·±æ¨ç†/å†³å®šä½•æ—¶ç»“æŸï¼‰ | æç®€ã€é«˜æ•ˆ tokenã€çœé’±ã€coding agent åœºæ™¯æœ€å¼ºï¼Œä½†å¯æ§æ€§è¾ƒå¼± |
| **Conversation First**ï¼ˆå¯¹è¯/åä½œä¼˜å…ˆï¼‰ | AutoGen, OpenAI Swarm | ä»£ç†é—´é€šè¿‡æ¶ˆæ¯/å¯¹è¯åä½œï¼ŒåŠ¨æ€è·¯ç”±ã€è¾©è®ºå¼æ¨ç† | ä¸­é«˜ï¼ˆå¯¹è¯åŠ¨æ€ï¼Œä½†å¯åŠ  supervisor é™è‡ªä¸»æ€§ï¼‰ | ç ”ç©¶ã€å¤æ‚æ¨ç†ã€å¤šè§’è‰²è¾©è®ºåœºæ™¯ |

### 1.2 Skill First çš„æ ¸å¿ƒç†å¿µ

```
ä¼ ç»Ÿ Tool First:  ç»™ Agent 100 ä¸ª tools â†’ æ¨¡å‹é€‰æ‹©å›°éš¾ â†’ token çˆ†ç‚¸ â†’ æ¨ç†æ··ä¹±
Skill First:       ç»™ Agent 4 ä¸ªåŸè¯­ + åŠ¨æ€æ³¨å…¥çš„ Skill prompt â†’ æ¨¡å‹è‡ªç”±æ¨ç† â†’ é«˜æ•ˆç²¾å‡†
```

**å…³é”®æ´å¯Ÿ**ï¼šSkill ä¸æ˜¯ function calling çš„ toolï¼Œè€Œæ˜¯æ³¨å…¥åˆ° system prompt ä¸­çš„ **æŒ‡å¯¼çŸ¥è¯†**ã€‚LLM è¯»å– Skill å†…å®¹åï¼Œä½¿ç”¨å°‘é‡å†…ç½®å·¥å…·ï¼ˆä¸»è¦æ˜¯ bashï¼‰æ¥å®Œæˆä»»åŠ¡ã€‚

è¿™æ˜¯ç†è§£ SkillKit çš„å…³é”®åŒºåˆ«ï¼š

| æ¦‚å¿µ | Toolï¼ˆä¼ ç»Ÿå·¥å…·ï¼‰ | Skillï¼ˆæŠ€èƒ½ï¼‰ |
|------|-----------------|-------------|
| **æ³¨å…¥ä½ç½®** | function calling schema | system prompt æ–‡æœ¬ |
| **æ¨¡å‹æ„ŸçŸ¥** | JSON schema æè¿° | è‡ªç„¶è¯­è¨€çŸ¥è¯† + æœ€ä½³å®è·µ |
| **æ‰§è¡Œæ–¹å¼** | æ¨¡å‹è¿”å›ç»“æ„åŒ–è°ƒç”¨ | æ¨¡å‹ç†è§£åç”¨ bash ç­‰åŸè¯­æ‰§è¡Œ |
| **æ‰©å±•æˆæœ¬** | éœ€è¦å†™ä»£ç  + æ³¨å†Œå‡½æ•° | åªéœ€å†™ä¸€ä¸ª Markdown æ–‡ä»¶ |
| **Token å¼€é”€** | æ¯ä¸ª tool éƒ½æœ‰ schema å  token | Skill å†…å®¹å¯ç¼“å­˜ï¼ŒæŒ‰éœ€åŠ è½½ |

### 1.3 "Skills are new software" çš„éšå–»

```
ä¼ ç»Ÿè½¯ä»¶ç”Ÿæ€:    æ“ä½œç³»ç»Ÿ â†’ åº”ç”¨ç¨‹åº â†’ ç”¨æˆ·æ“ä½œ
Agent æ–°ç”Ÿæ€:    Agent (æ–° OS) â†’ Skills (æ–°è½¯ä»¶) â†’ è‡ªç„¶è¯­è¨€æŒ‡ä»¤

ä¼ ç»Ÿ API è°ƒç”¨:   HTTP Client â†’ REST API â†’ JSON Response
Agent æ–°èŒƒå¼:    Agent â†’ CLI å‘½ä»¤ (æ–° API) â†’ æ–‡æœ¬è¾“å‡º

ä¼ ç»Ÿ UI:         å›¾å½¢ç•Œé¢ â†’ é¼ æ ‡ç‚¹å‡» â†’ è§†è§‰åé¦ˆ
Agent æ–° UI:     å¤šæ¨¡æ€è¾“å…¥ â†’ è‡ªç„¶è¯­è¨€ â†’ ç»“æ„åŒ–è¾“å‡º
```

---

## 2. æ•´ä½“æ¶æ„æ¦‚è§ˆ

### 2.1 Agent + Skills + è™šæ‹Ÿæœº æ¶æ„

SkillKit çš„æ¶æ„å¯ä»¥ç±»æ¯”ä¸ºä¸€å°"Agent è™šæ‹Ÿæœº"ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent Configuration                                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚              Core System Prompt                      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                             â”‚
â”‚  Equipped Skills:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚bigquery â”‚ â”‚  docx   â”‚ â”‚nda-review â”‚ â”‚ pdf â”‚ â”‚ pptx â”‚ â”‚ xlsx â”‚ ...    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”€â”€â”€â”€â”€â†’    â”‚
â”‚  Equipped MCP Servers:                                   use computer     â”‚
â”‚  â—‹ MCP server 1                                                           â”‚
â”‚  â—‹ MCP server 2                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â—‹ MCP server 3                                          â”‚ Agent Virtual â”‚â”‚
â”‚       â”‚  â”‚  â”‚                                            â”‚   Machine     â”‚â”‚
â”‚       â–¼  â–¼  â–¼                                            â”‚               â”‚â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚   Remote MCP Servers               â”‚                  â”‚ â”‚Bashâ”‚â”‚Pythonâ”‚â”‚â”‚
â”‚  â”‚   (elsewhere on the internet)      â”‚                  â”‚ â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚â”‚
â”‚                                                          â”‚ â”‚Node.jsâ”‚     â”‚â”‚
â”‚                                                          â”‚ â””â”€â”€â”€â”€â”€â”€â”˜      â”‚â”‚
â”‚                                                          â”‚               â”‚â”‚
â”‚                                                          â”‚ File System:  â”‚â”‚
â”‚                                                          â”‚ skills/       â”‚â”‚
â”‚                                                          â”‚  bigquery/    â”‚â”‚
â”‚                                                          â”‚   SKILL.md    â”‚â”‚
â”‚                                                          â”‚   rules.md    â”‚â”‚
â”‚                                                          â”‚  pdf/         â”‚â”‚
â”‚                                                          â”‚   SKILL.md    â”‚â”‚
â”‚                                                          â”‚   forms.md    â”‚â”‚
â”‚                                                          â”‚   extract.py  â”‚â”‚
â”‚                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¦ç‚¹**ï¼šSkill ç›®å½•ä¸ä»…åŒ…å« SKILL.mdï¼Œè¿˜å¯ä»¥åŒ…å«è¾…åŠ©æ–‡ä»¶ï¼ˆæ•°æ®æºé…ç½®ã€æ¨¡æ¿ã€è„šæœ¬ç­‰ï¼‰ï¼Œè¿™äº›éƒ½å­˜åœ¨äº Agent çš„"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"ä¸­ï¼ŒAgent å¯ä»¥é€šè¿‡ `read` å·¥å…·è®¿é—®ã€‚

### 2.2 Agent Loop æ‰§è¡Œæ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GOAL                                     â”‚
â”‚  "handle this lead" / ç”¨æˆ·ä»»åŠ¡æè¿°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AGENT LOOP                               â”‚
â”‚  observe â†’ think â†’ act â†’ learn â†’ repeat  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚           â”‚
       â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBAGENTS  â”‚â”‚ SKILLS   â”‚â”‚ TOOLS         â”‚
â”‚            â”‚â”‚          â”‚â”‚               â”‚
â”‚ code-      â”‚â”‚ lead-    â”‚â”‚ Built-in:     â”‚
â”‚  reviewer  â”‚â”‚  researchâ”‚â”‚ Read, Write,  â”‚
â”‚ test-      â”‚â”‚          â”‚â”‚ Bash, Grep... â”‚
â”‚  runner    â”‚â”‚ email-   â”‚â”‚               â”‚
â”‚ researcher â”‚â”‚  draftingâ”‚â”‚ MCP:          â”‚
â”‚            â”‚â”‚          â”‚â”‚ Zapier, DBs,  â”‚
â”‚ (parallel, â”‚â”‚ (domain  â”‚â”‚ APIs...       â”‚
â”‚  isolated) â”‚â”‚ expertiseâ”‚â”‚               â”‚
â”‚            â”‚â”‚  auto-   â”‚â”‚ Custom:       â”‚
â”‚            â”‚â”‚ invoked) â”‚â”‚ your functionsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOOKS                                    â”‚
â”‚  guard rails, logging, human-in-the-loop â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STRUCTURED OUTPUT                        â”‚
â”‚  validated JSON matching your schema      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰æ¡å¹¶è¡Œè·¯å¾„**ï¼š
- **Subagents**ï¼šå¹¶è¡Œéš”ç¦»çš„å­ä»£ç†ï¼ˆä»£ç å®¡æŸ¥ã€æµ‹è¯•è¿è¡Œã€è°ƒç ”ï¼‰
- **Skills**ï¼šé¢†åŸŸä¸“ä¸šçŸ¥è¯†ï¼Œè‡ªåŠ¨æ ¹æ®ä¸Šä¸‹æ–‡è°ƒç”¨
- **Tools**ï¼šå†…ç½®å·¥å…· + MCP æœåŠ¡å™¨ + è‡ªå®šä¹‰å‡½æ•°

### 2.3 ç³»ç»Ÿåˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·äº¤äº’å±‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ CLI/TUI  â”‚  â”‚  Web UI  â”‚  â”‚ RPC Mode â”‚  â”‚ JSON Modeâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AgentRunnerï¼ˆä»£ç†è¿è¡Œå™¨ï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ EventBus    â”‚  â”‚ContextManagerâ”‚  â”‚SessionManagerâ”‚               â”‚
â”‚  â”‚ (äº‹ä»¶+Hooks)â”‚  â”‚ (ä¸Šä¸‹æ–‡ç®¡ç†) â”‚  â”‚ (ä¼šè¯æŒä¹…åŒ–) â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SkillsEngineï¼ˆæŠ€èƒ½å¼•æ“ï¼‰                        â”‚
â”‚                                                                     â”‚
â”‚  Skill Files â”€â”€â†’ [Loader] â”€â”€â†’ [Filter] â”€â”€â†’ [Snapshot] â”€â”€â†’ Prompt  â”‚
â”‚  (SKILL.md)     è§£ææŠ€èƒ½      èµ„æ ¼æ£€æŸ¥      ç¼“å­˜å¿«ç…§     æ³¨å…¥LLM   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Markdown â”‚  â”‚ Default  â”‚  â”‚   Bash   â”‚  â”‚ OpenAI / â”‚           â”‚
â”‚  â”‚ Loader   â”‚  â”‚ Filter   â”‚  â”‚ Runtime  â”‚  â”‚ Anthropicâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Adapter  â”‚           â”‚
â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨å¯æ’æ‹”ä½“ç³»                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Memory   â”‚  â”‚Extensionsâ”‚  â”‚ Packages â”‚  â”‚ Context  â”‚           â”‚
â”‚  â”‚(OpenViking)â”‚ â”‚ (MCP+æ’ä»¶)â”‚ â”‚ (åŒ…ç®¡ç†) â”‚  â”‚  Files   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Themes   â”‚  â”‚PromptTpl â”‚                                        â”‚
â”‚  â”‚ (ä¸»é¢˜)   â”‚  â”‚ (æ¨¡æ¿)   â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒä½“ç³»è¯¦è§£

### 3.1 Skills æŠ€èƒ½ä½“ç³»

Skills æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒã€‚ä¸€ä¸ª Skill æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**ç›®å½•**ï¼ŒåŒ…å«ä¸»æè¿°æ–‡ä»¶å’Œè¾…åŠ©èµ„æºã€‚

#### 3.1.1 Skill ç›®å½•ç»“æ„

ä¸€ä¸ª Skill ä¸åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç›®å½•ï¼š

```
skills/
â”œâ”€â”€ bigquery/
â”‚   â”œâ”€â”€ SKILL.md           # ä¸»æ–‡ä»¶ï¼šYAML frontmatter + Markdown æŒ‡ä»¤
â”‚   â”œâ”€â”€ datasources.md     # è¾…åŠ©ï¼šå¯ç”¨çš„æ•°æ®æºåˆ—è¡¨
â”‚   â””â”€â”€ rules.md           # è¾…åŠ©ï¼šæŸ¥è¯¢è§„åˆ™å’Œçº¦æŸ
â”‚
â”œâ”€â”€ docx/
â”‚   â”œâ”€â”€ SKILL.md
â”‚   â”œâ”€â”€ ooxml/             # è¾…åŠ©ï¼šæ¨¡æ¿å’Œè§„èŒƒ
â”‚   â”œâ”€â”€ spec.md
â”‚   â””â”€â”€ editing.md
â”‚
â”œâ”€â”€ pdf/
â”‚   â”œâ”€â”€ SKILL.md
â”‚   â”œâ”€â”€ forms.md           # è¾…åŠ©ï¼šè¡¨å•å¤„ç†æŒ‡å—
â”‚   â”œâ”€â”€ reference.md       # è¾…åŠ©ï¼šå‚è€ƒæ–‡æ¡£
â”‚   â””â”€â”€ extract_fields.py  # è¾…åŠ©ï¼šå¯æ‰§è¡Œè„šæœ¬ï¼ˆActionï¼‰
â”‚
â””â”€â”€ nda-review/
    â””â”€â”€ SKILL.md           # ç®€å• Skillï¼šåªæœ‰ä¸»æ–‡ä»¶
```

**æ ¸å¿ƒç†è§£**ï¼šSKILL.md æ˜¯ Agent çš„"å…¥å£è¯´æ˜ä¹¦"ï¼Œè¾…åŠ©æ–‡ä»¶æ˜¯ Agent å¯ä»¥ç”¨ `read` å·¥å…·æŒ‰éœ€æŸ¥é˜…çš„"å‚è€ƒæ‰‹å†Œ"ã€‚Agent çš„ system prompt ä¸­åªæ³¨å…¥ SKILL.md çš„å†…å®¹ï¼Œè¾…åŠ©æ–‡ä»¶åœ¨éœ€è¦æ—¶æ‰è¯»å–ï¼Œå®ç°äº†çŸ¥è¯†çš„æŒ‰éœ€åŠ è½½ã€‚

#### 3.1.2 SKILL.md å®šä¹‰æ ¼å¼

```yaml
# skills/github/SKILL.md
---
name: github
description: "Interact with GitHub repositories, issues, and PRs using the gh CLI"
metadata:
  emoji: "ğŸ™"
  homepage: "https://cli.github.com"
  author: "Alex Zhang"
  version: "1.0.0"
  tags: ["git", "devops"]
  primary_env: "GITHUB_TOKEN"        # ä¸» API Keyï¼ˆFilter ç”¨æ­¤æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼‰
  requires:
    bins: ["gh"]                      # æ‰€æœ‰å¿…é¡»å­˜åœ¨çš„äºŒè¿›åˆ¶ï¼ˆAND é€»è¾‘ï¼‰
    any_bins: ["npm", "pnpm"]         # è‡³å°‘ä¸€ä¸ªå­˜åœ¨ï¼ˆOR é€»è¾‘ï¼‰
    env: ["GITHUB_TOKEN"]             # å¿…é¡»çš„ç¯å¢ƒå˜é‡
    os: ["darwin", "linux"]           # æ”¯æŒçš„æ“ä½œç³»ç»Ÿ
  install:                            # è‡ªåŠ¨å®‰è£…å»ºè®®
    - kind: brew
      id: gh
      label: "GitHub CLI (Homebrew)"
      bins: ["gh"]
      os: ["darwin", "linux"]
  invocation:
    user_invocable: true              # ç”¨æˆ·å¯é€šè¿‡ /github ç›´æ¥è°ƒç”¨
    disable_model_invocation: false   # æ˜¯å¦ä» LLM system prompt éšè—
    require_confirmation: false       # æ‰§è¡Œå‰æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤
actions:                              # ç¡®å®šæ€§è„šæœ¬åŠ¨ä½œï¼ˆé LLM æ¨ç†ï¼‰
  create-issue:
    script: "scripts/create-issue.sh"
    description: "Create a new GitHub issue"
    output: "json"
    params:
      - name: title
        type: string
        required: true
        position: 1
      - name: body
        type: string
        required: false
---
# GitHub CLI Skill

You have access to the GitHub CLI (`gh`).
Use it to manage repositories, issues, pull requests, and more.

## Common Operations

- List issues: `gh issue list`
- Create PR: `gh pr create --title "..." --body "..."`
- View PR status: `gh pr status`

## Best Practices

- Always check `gh auth status` before operations
- Use `--json` flag for structured output when parsing results
```

#### 3.1.3 Skill æ•°æ®æ¨¡å‹

```python
@dataclass
class Skill:
    name: str                    # å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ "github"ï¼‰
    description: str             # ä¸€è¡Œæè¿°ï¼ˆä¾› LLM æ¦‚è§ˆç”¨ï¼‰
    content: str                 # å®Œæ•´ Markdown å†…å®¹ï¼ˆæ³¨å…¥ system promptï¼‰
    file_path: Path              # SKILL.md çš„å®Œæ•´è·¯å¾„
    base_dir: Path               # Skill ç›®å½•è·¯å¾„ï¼ˆç”¨äºè§£æè¾…åŠ©æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ï¼‰
    source: SkillSource          # æ¥æºï¼šBUNDLED / MANAGED / WORKSPACE / PLUGIN / EXTRA
    metadata: SkillMetadata      # æ‰©å±•å…ƒæ•°æ®ï¼ˆè§ä¸‹ï¼‰
    actions: dict[str, SkillAction]  # ç¡®å®šæ€§åŠ¨ä½œï¼ˆè„šæœ¬æ˜ å°„ï¼‰

    def content_hash(self) -> str:
        """SHA256 å“ˆå¸Œçš„å‰ 16 ä½ï¼Œç”¨äºç¼“å­˜å¤±æ•ˆæ£€æµ‹"""
        return hashlib.sha256(self.content.encode()).hexdigest()[:16]

    @property
    def skill_key(self) -> str:
        """é…ç½®æŸ¥æ‰¾é”®ï¼ˆå¯è‡ªå®šä¹‰ï¼Œé»˜è®¤ = nameï¼‰"""
        return self.metadata.skill_key or self.name

@dataclass
class SkillMetadata:
    always: bool = False          # å§‹ç»ˆåŒ…å«ï¼ˆè·³è¿‡ Filter æ£€æŸ¥ï¼‰
    skill_key: str | None = None  # è‡ªå®šä¹‰é…ç½®æŸ¥æ‰¾é”®
    primary_env: str | None = None # ä¸»è¦ç¯å¢ƒå˜é‡ï¼ˆå¦‚ "GITHUB_TOKEN"ï¼‰
    emoji: str | None = None      # æ˜¾ç¤ºå›¾æ ‡
    homepage: str | None = None
    author: str | None = None
    version: str | None = None
    tags: list[str] = []          # åˆ†ç±»æ ‡ç­¾
    requires: SkillRequirements   # è¿è¡Œè¦æ±‚
    install: list[SkillInstallSpec] = []  # å®‰è£…è¯´æ˜
    invocation: SkillInvocationPolicy = ... # è°ƒç”¨ç­–ç•¥

@dataclass
class SkillRequirements:
    bins: list[str] = []          # ALL å¿…é¡»å­˜åœ¨
    any_bins: list[str] = []      # è‡³å°‘ ONE å­˜åœ¨
    env: list[str] = []           # å¿…é¡»çš„ç¯å¢ƒå˜é‡
    config: list[str] = []        # å¿…é¡»çš„é…ç½®è·¯å¾„
    os: list[str] = []            # æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼ˆdarwin/linux/win32ï¼‰
```

#### 3.1.4 Skill æ¥æºä¼˜å…ˆçº§ï¼ˆè¦†ç›–æœºåˆ¶ï¼‰

```
BUNDLED (å†…ç½®)  â†’  MANAGED (~/.skillkit/skills)  â†’  WORKSPACE (./skills)  â†’  EXTRA
    ä½ä¼˜å…ˆçº§                                                                é«˜ä¼˜å…ˆçº§
```

ååŠ è½½çš„ç›®å½•è¦†ç›–å…ˆåŠ è½½çš„åŒå Skillã€‚è¿™æ„å‘³ç€ï¼š
- æ¡†æ¶å†…ç½® github Skill â†’ ç”¨æˆ·å…¨å±€è‡ªå®šä¹‰ç‰ˆè¦†ç›– â†’ é¡¹ç›®çº§ç‰ˆæœ¬å†è¦†ç›–
- ç±»ä¼¼ Linux é…ç½®æ–‡ä»¶ `/etc/` â†’ `~/.config/` â†’ `./.config/` çš„ä¼˜å…ˆçº§æœºåˆ¶

#### 3.1.5 Skill åŠ è½½ç®¡çº¿

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            MarkdownSkillLoader                â”‚
                â”‚                                              â”‚
SKILL.md â”€â”€â”€â”€â”€â”€â†’â”‚ 1. è¯»å–æ–‡ä»¶å†…å®¹                              â”‚
                â”‚ 2. åˆ†ç¦» YAML frontmatter å’Œ Markdown body   â”‚
                â”‚ 3. è§£æ metadata, requirements, actions      â”‚
                â”‚ 4. æ„å»º Skill å¯¹è±¡                          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            DefaultSkillFilter                 â”‚
                â”‚                                              â”‚
                â”‚ çŸ­è·¯æ£€æŸ¥ï¼ˆæŒ‰åºï¼Œé¦–ä¸ªå¤±è´¥å³è·³è¿‡è¯¥ Skillï¼‰ï¼š     â”‚
                â”‚ â‘  always=true? â†’ ç›´æ¥é€šè¿‡                    â”‚
                â”‚ â‘¡ é…ç½®ä¸­ enabled=false? â†’ æ’é™¤               â”‚
                â”‚ â‘¢ åœ¨ exclude_skills åˆ—è¡¨ä¸­? â†’ æ’é™¤           â”‚
                â”‚ â‘£ åœ¨ bundled allowlist ä¸­? â†’ æ£€æŸ¥            â”‚
                â”‚ â‘¤ OS åŒ¹é…? (sys.platform)                   â”‚
                â”‚ â‘¥ æ‰€æœ‰ bins å­˜åœ¨? (shutil.which)            â”‚
                â”‚ â‘¦ any_bins è‡³å°‘ä¸€ä¸ªå­˜åœ¨?                     â”‚
                â”‚ â‘§ ç¯å¢ƒå˜é‡å­˜åœ¨?ï¼ˆä¸‰çº§æŸ¥æ‰¾ï¼‰                   â”‚
                â”‚ â‘¨ é…ç½®è·¯å¾„å­˜åœ¨?                              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            SkillSnapshotï¼ˆä¸å¯å˜å¿«ç…§ï¼‰         â”‚
                â”‚                                              â”‚
                â”‚ skills: list[Skill]    # åˆæ ¼çš„æŠ€èƒ½åˆ—è¡¨      â”‚
                â”‚ prompt: str            # é¢„æ ¼å¼åŒ–çš„ Prompt    â”‚
                â”‚ version: int           # ç‰ˆæœ¬å·ï¼ˆç¼“å­˜é”®ï¼‰    â”‚
                â”‚ timestamp: float       # åˆ›å»ºæ—¶é—´            â”‚
                â”‚ source_dirs: list[Path] # æ‰«æçš„ç›®å½•         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¯å¢ƒå˜é‡ä¸‰çº§æŸ¥æ‰¾**ï¼ˆFilter ä¸­çš„ `_has_env` é€»è¾‘ï¼‰ï¼š
```
æ£€æŸ¥ç¯å¢ƒå˜é‡ "GITHUB_TOKEN" æ˜¯å¦å¯ç”¨:
  Level 1: os.environ["GITHUB_TOKEN"] å­˜åœ¨?
  Level 2: é…ç½®æ–‡ä»¶ entries.github.api_key å­˜åœ¨?ï¼ˆæ˜ å°„åˆ° primary_envï¼‰
  Level 3: é…ç½®æ–‡ä»¶ entries.github.env.GITHUB_TOKEN å­˜åœ¨?
```

#### 3.1.6 Prompt æ ¼å¼åŒ–

Skill å†…å®¹æ ¼å¼åŒ–ä¸ºä¸‰ç§æ ¼å¼æ³¨å…¥ LLM system promptï¼š

**XML æ ¼å¼ï¼ˆé»˜è®¤ï¼ŒLLM è§£ææœ€ä½³ï¼‰ï¼š**
```xml
<skills>
  <skill name="github" emoji="ğŸ™">
    <description>Interact with GitHub using gh CLI</description>
    <content>
      You have access to the GitHub CLI (`gh`)...
    </content>
  </skill>
</skills>
```

**Markdown æ ¼å¼** / **JSON æ ¼å¼** ä¹Ÿå¯æŒ‰éœ€é€‰æ‹©ã€‚

#### 3.1.7 Skill çš„ /command è°ƒç”¨

ç”¨æˆ·å¯ä»¥é€šè¿‡ `/skill-name` ç›´æ¥è°ƒç”¨ Skillï¼Œç±»ä¼¼ Slash Commandï¼š

```python
# ç”¨æˆ·è¾“å…¥: "/github create an issue for the login bug"
# å†…éƒ¨å¤„ç†:
def _check_skill_invocation(self, user_input: str) -> Skill | None:
    match = re.match(r"^/(\S+)", user_input.strip())
    if match:
        return self.get_skill(match.group(1))
    return None

# åŒ¹é…åˆ° github skill åï¼Œæ³¨å…¥å®Œæ•´ skill å†…å®¹åˆ°æ¶ˆæ¯ä¸­
skill_context = (
    f"[User invoked skill: /{skill.name}]\n\n"
    f"<skill-content name=\"{skill.name}\">\n"
    f"{skill.content}\n"
    f"</skill-content>\n\n"
    f"User input: {user_input}"
)
```

---

### 3.2 Agent ä»£ç†ä½“ç³»

AgentRunner æ˜¯æœ€ä¸Šå±‚çš„ç¼–æ’å™¨ï¼Œå®ç°äº†å®Œæ•´çš„ **observe â†’ think â†’ act â†’ learn â†’ repeat** å¾ªç¯ã€‚

#### 3.2.1 Agent é…ç½®

```python
@dataclass
class AgentConfig:
    # LLM è®¾ç½®
    model: str = "MiniMax-M2.1"           # æ¨¡å‹ ID
    base_url: str | None = None           # API base URLï¼ˆé»˜è®¤ OPENAI_BASE_URLï¼‰
    api_key: str | None = None            # API Keyï¼ˆé»˜è®¤ OPENAI_API_KEYï¼‰
    temperature: float = 0.0              # é‡‡æ ·æ¸©åº¦
    max_tokens: int = 8192                # æœ€å¤§è¾“å‡º token

    # Agent è¡Œä¸º
    max_turns: int = 50                   # æœ€å¤§å·¥å…·è°ƒç”¨è½®æ¬¡
    enable_tools: bool = True             # å¯ç”¨ function calling
    enable_reasoning: bool = False        # å¯ç”¨æ¨ç†æ¨¡å¼
    auto_execute: bool = True             # è‡ªåŠ¨æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆæ— éœ€ç¡®è®¤ï¼‰

    # æ€è€ƒ & ä¼ è¾“
    thinking_level: ThinkingLevel = None  # off/minimal/low/medium/high/xhigh
    transport: Transport = "sse"          # sse/websocket/auto

    # Skills
    skill_dirs: list[Path] = []           # æŠ€èƒ½ç›®å½•åˆ—è¡¨
    watch_skills: bool = False            # æ–‡ä»¶ç›‘å¬çƒ­é‡è½½
    system_prompt: str = ""               # åŸºç¡€ç³»ç»Ÿæç¤ºè¯

    # ç¼“å­˜ & ä¸Šä¸‹æ–‡
    cache_retention: str = "short"        # none/short/long
    session_id: str | None = None         # ä¼šè¯ IDï¼ˆç¼“å­˜é”®ï¼‰
    load_context_files: bool = True       # è‡ªåŠ¨å‘ç° AGENTS.md / CLAUDE.md
```

#### 3.2.2 Agent æ‰§è¡Œå¾ªç¯ï¼ˆå®Œæ•´æµç¨‹å›¾ï¼‰

```
ç”¨æˆ·è¾“å…¥ "å¸®æˆ‘ä¿®å¤ç™»å½• bug"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. emit(INPUT) â†’ å¯è½¬æ¢/æ‹¦æˆª/ç›´æ¥å¤„ç†            â”‚
â”‚ 2. æ£€æŸ¥ /skill-name è°ƒç”¨? â†’ è‹¥æ˜¯åˆ™æ³¨å…¥ skill    â”‚
â”‚ 3. æ„å»ºæ¶ˆæ¯åˆ—è¡¨ (system prompt + history + user) â”‚
â”‚ 4. emit(AGENT_START) â†’ Memory åˆ›å»º session      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ emit(TURN_START)    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ context å‹ç¼©æ£€æŸ¥    â”‚                    â”‚
          â”‚ emit(CONTEXT_TRANSFORM) â†’ Memory åŒæ­¥   â”‚
          â”‚ è°ƒç”¨ LLM (stream)  â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                     â”‚                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
          â”‚ LLM è¿”å›å“åº”        â”‚                    â”‚
          â”‚ emit(TURN_END)      â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                     â”‚                               â”‚
              æœ‰ tool_calls?                         â”‚
             â”Œâ”€â”€YESâ”€â”€â”´â”€â”€NOâ”€â”€â”                        â”‚
             â”‚              â”‚                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â–¼                        â”‚
    â”‚emit(BEFORE_TOOL) â”‚  è¿”å›æœ€ç»ˆå“åº”                â”‚
    â”‚â†’ Hooks å¯é˜»æ­¢    â”‚  emit(AGENT_END)            â”‚
    â”‚â†’ å¯ä¿®æ”¹å‚æ•°      â”‚  â†’ Memory commit            â”‚
    â”‚                  â”‚                             â”‚
    â”‚ æ‰§è¡Œå·¥å…·(bash)   â”‚                             â”‚
    â”‚ â†’ BashRuntime    â”‚                             â”‚
    â”‚ â†’ æµå¼è¾“å‡º       â”‚                             â”‚
    â”‚ â†’ æ”¯æŒä¸­æ­¢       â”‚                             â”‚
    â”‚                  â”‚                             â”‚
    â”‚emit(AFTER_TOOL)  â”‚                             â”‚
    â”‚â†’ å¯ä¿®æ”¹ç»“æœ      â”‚                             â”‚
    â”‚                  â”‚                             â”‚
    â”‚ æ£€æŸ¥ steering?   â”‚                             â”‚
    â”‚ æ£€æŸ¥ follow_up?  â”‚                             â”‚
    â”‚ æ£€æŸ¥ abort?      â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
             â”‚                                       â”‚
             â”‚  turn < max_turns?                    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€YESâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 ä¸‰ç§å“åº”æ¨¡å¼

```python
# æ¨¡å¼ 1: åŒæ­¥ç­‰å¾…å®Œæ•´å“åº”
response: AgentMessage = await agent.chat("Fix the bug in auth.py")
print(response.content)

# æ¨¡å¼ 2: æµå¼æ–‡æœ¬å¢é‡ï¼ˆæœ€ç®€å•ï¼‰
async for delta in agent.chat_stream("Explain this code"):
    print(delta, end="", flush=True)

# æ¨¡å¼ 3: ç»“æ„åŒ–äº‹ä»¶æµï¼ˆæœ€å¼ºå¤§ï¼ŒTUI/Web ç”¨ï¼‰
async for event in agent.chat_stream_events("Refactor this"):
    match event.type:
        case "thinking_delta": show_thinking(event.content)  # æ€è€ƒè¿‡ç¨‹
        case "text_delta":     append_text(event.content)    # æ–‡æœ¬è¾“å‡º
        case "tool_call_start": show_tool(event.tool_name)   # å·¥å…·è°ƒç”¨å¼€å§‹
        case "tool_call_delta": update_args(event.args_delta)# å‚æ•°æµå¼è§£æ
        case "tool_result":    show_result(event.content)    # å·¥å…·ç»“æœ
        case "done":           finish(event.finish_reason)   # å®Œæˆ
```

#### 3.2.4 ä¸­æ–­ã€è½¬å‘ä¸è¿½åŠ 

```python
# ç´§æ€¥ä¸­æ­¢ï¼šç«‹å³åœæ­¢æ‰€æœ‰æ“ä½œï¼ˆæ€æ‰æ­£åœ¨è¿è¡Œçš„ subprocessï¼‰
agent.abort()

# è½¬å‘ï¼šæ³¨å…¥æ–°æŒ‡ä»¤ï¼Œå½“å‰å·¥å…·æ‰§è¡Œå®Œæˆååˆ‡æ¢æ–¹å‘
agent.steer("Stop refactoring, focus on the failing tests instead")

# è¿½åŠ ï¼šåœ¨å½“å‰å¾ªç¯ç»“æŸåè¿½åŠ æ–°ä»»åŠ¡
agent.follow_up("Also run the linter after fixing")
```

#### 3.2.5 å¤šæ¨¡æ€æ¶ˆæ¯æ”¯æŒ

```python
@dataclass
class AgentMessage:
    role: str                              # "user" / "assistant" / "system" / "tool"
    content: str | list[TextContent | ImageContent]  # æ”¯æŒæ–‡æœ¬ + å›¾ç‰‡æ··åˆ
    tool_calls: list[dict] = []            # LLM å‘èµ·çš„å·¥å…·è°ƒç”¨
    reasoning: str | None = None           # æ€è€ƒè¿‡ç¨‹ï¼ˆæ”¯æŒ thinking çš„æ¨¡å‹ï¼‰
    token_usage: TokenUsage | None = None  # Token ç”¨é‡ç»Ÿè®¡

# å¤šæ¨¡æ€ç¤ºä¾‹
message = AgentMessage(
    role="user",
    content=[
        TextContent(type="text", text="è¿™ä¸ª UI æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"),
        ImageContent(type="image", data="base64...", mime_type="image/png"),
    ]
)
```

---

### 3.3 Tools å·¥å…·ä½“ç³»

Skill First çš„æ ¸å¿ƒåŸåˆ™ï¼š**æå°‘å†…ç½®å·¥å…· + Skills çŸ¥è¯† = æ— é™èƒ½åŠ›ã€‚**

#### 3.3.1 å†…ç½®åŸè¯­å·¥å…·ï¼ˆä»… 4 ä¸ª function calling toolsï¼‰

è¿™æ˜¯ Agent é€šè¿‡ function calling å¯ä»¥è°ƒç”¨çš„å…¨éƒ¨å·¥å…·ï¼š

| å·¥å…· | åŠŸèƒ½ | å…³é”®å‚æ•° |
|------|------|---------|
| `execute` | æ‰§è¡Œå•æ¡ bash å‘½ä»¤ | command, timeout, cwd |
| `execute_script` | æ‰§è¡Œå¤šè¡Œè„šæœ¬ | script, timeout, cwd |
| `read` | è¯»å–æ–‡ä»¶å†…å®¹ | path, offset, limit |
| `write` | å†™å…¥æ–‡ä»¶ | path, content |

**ä¸ºä»€ä¹ˆåªæœ‰ 4 ä¸ªï¼Ÿ**

```
ä¼ ç»Ÿæ–¹å¼ï¼š                              Skill First æ–¹å¼ï¼š
tool: search_github_issues()          skill: "Use `gh issue list --json` to search issues"
tool: create_github_pr()              skill: "Use `gh pr create` to create PRs"
tool: run_pytest()        â”€â”€â”€â”€â†’       skill: "Use `pytest -v` to run tests"
tool: deploy_to_k8s()                 skill: "Use `kubectl apply -f` to deploy"
...100+ tools                         ...å…¨ç”¨ bash execute
```

bash æ˜¯ä¸‡èƒ½çš„ã€‚ä¸å…¶ä¸ºæ¯ä¸ª API å†™ wrapper toolï¼ˆå¢åŠ  token å¼€é”€ï¼‰ï¼Œä¸å¦‚æ•™æ¨¡å‹æ€ä¹ˆç”¨ CLIã€‚è¿™å°±æ˜¯ **"CLIs are new API"** çš„å®è·µã€‚

#### 3.3.2 æ‰©å±•å·¥å…·é›†ï¼ˆç»™ TUI/CLI ä½¿ç”¨ï¼Œé function callingï¼‰

```python
# ToolRegistry ç®¡ç†çš„å·¥å…·ï¼ˆç”¨äºå†…éƒ¨é€»è¾‘ï¼Œä¸æš´éœ²ç»™ LLM function callingï¼‰
create_coding_tools()     # â†’ Read, Write, Edit, Bashï¼ˆä»£ç ç¼–è¾‘åœºæ™¯ï¼‰
create_read_only_tools()  # â†’ Read, Grep, Find, Lsï¼ˆåªè¯»åˆ†æåœºæ™¯ï¼‰
create_all_tools()        # â†’ å…¨éƒ¨ 7 ä¸ª
```

| å†…éƒ¨å·¥å…· | åŠŸèƒ½äº®ç‚¹ |
|---------|---------|
| `BashTool` | 100K å­—ç¬¦è¾“å‡ºé™åˆ¶ï¼Œ120s è¶…æ—¶ï¼Œæµå¼è¾“å‡º |
| `ReadTool` | cat -n æ ¼å¼è¡Œå·ï¼Œbase64 å›¾ç‰‡æ”¯æŒï¼Œ2000 è¡Œé»˜è®¤ |
| `WriteTool` | è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•ï¼Œè¿”å›å­—èŠ‚æ•°ç»Ÿè®¡ |
| `EditTool` | ç²¾ç¡®å­—ç¬¦ä¸²æ›¿æ¢ï¼Œæ¨¡ç³ŠåŒ¹é…æç¤ºï¼ˆdifflibï¼‰ï¼Œç»Ÿä¸€ diff è¾“å‡º |
| `FindTool` | Glob æ¨¡å¼ï¼Œgit ls-files ä¼˜å…ˆå°Šé‡ .gitignore |
| `GrepTool` | ä¼˜å…ˆç”¨ ripgrep åŠ é€Ÿï¼Œå›é€€åˆ° Python regex |
| `LsTool` | é€’å½’ 1000 æ¡å®‰å…¨é™åˆ¶ï¼Œé•¿æ ¼å¼æ˜¾ç¤º |

#### 3.3.3 å·¥å…·æ‰§è¡Œå¼•æ“ï¼ˆBashRuntimeï¼‰

BashRuntime å®ç°äº†é«˜æ€§èƒ½çš„å‘½ä»¤æ‰§è¡Œï¼Œæœ‰ä¸¤æ¡è·¯å¾„ï¼š

```
                    execute(command, timeout, on_output, abort_signal)
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ æ˜¯å¦éœ€è¦æµå¼è¾“å‡º â”‚
                            â”‚   æˆ–ä¸­æ­¢æ”¯æŒï¼Ÿ   â”‚
                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                                 â”‚        â”‚
                            NO   â”‚        â”‚ YES
                                 â–¼        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ å¿«é€Ÿè·¯å¾„ â”‚ â”‚     æµå¼è·¯å¾„          â”‚
                          â”‚          â”‚ â”‚                      â”‚
                          â”‚communicateâ”‚ â”‚ å¹¶å‘ä»»åŠ¡ï¼š           â”‚
                          â”‚ (ç­‰å¾…å®Œæˆ)â”‚ â”‚ â”œâ”€ _read_stream(stdout)
                          â”‚          â”‚ â”‚ â”œâ”€ _read_stream(stderr)
                          â”‚          â”‚ â”‚ â””â”€ _watch_abort()     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                      â”‚
                                       â”‚ asyncio.wait(timeout)â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **åä½œå¼ä¸­æ­¢**ï¼šé€šè¿‡ `asyncio.Event` ä¿¡å·è§¦å‘ `process.kill()`
- **æµå¼è¾“å‡ºå›è°ƒ**ï¼šé€è¡Œè¯»å–ï¼Œå®æ—¶å›è°ƒ `on_output(line)`
- **è¾“å‡ºæˆªæ–­**ï¼š1MB ä¸Šé™é˜²æ­¢å†…å­˜æº¢å‡º
- **è¶…æ—¶æ§åˆ¶**ï¼š1-600 ç§’å¯é…ç½®

---

### 3.4 Memory è®°å¿†ä½“ç³»

åŸºäº OpenViking ä¸Šä¸‹æ–‡æ•°æ®åº“çš„è·¨ä¼šè¯æŒä¹…åŒ–è®°å¿†ï¼Œé€šè¿‡ Extension æœºåˆ¶æ¥å…¥ã€‚

#### 3.4.1 æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentRunner                         â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   EventBus    â”‚  â”‚     Extension Manager        â”‚ â”‚
â”‚  â”‚               â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ AGENT_START â”€â”€â”¼â”€â”€â”¼â†’ MemoryHooks.on_agent_start â”‚ â”‚
â”‚  â”‚ CONTEXT_â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â†’ MemoryHooks.on_context_    â”‚ â”‚
â”‚  â”‚  TRANSFORM    â”‚  â”‚    transform                â”‚ â”‚
â”‚  â”‚ AGENT_END â”€â”€â”€â”€â”¼â”€â”€â”¼â†’ MemoryHooks.on_agent_end   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                              â”‚ â”‚
â”‚                     â”‚  LLM å¯ç”¨çš„ Memory Tools:    â”‚ â”‚
â”‚                     â”‚  â”œâ”€ recall_memory (æœç´¢è®°å¿†)  â”‚ â”‚
â”‚                     â”‚  â”œâ”€ save_memory (ä¿å­˜è®°å¿†)    â”‚ â”‚
â”‚                     â”‚  â”œâ”€ explore_memory (æµè§ˆè®°å¿†) â”‚ â”‚
â”‚                     â”‚  â””â”€ add_knowledge (ç´¢å¼•æ–‡ä»¶)  â”‚ â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ HTTP (async httpx)
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   OpenViking Server  â”‚
                          â”‚  (ä¸Šä¸‹æ–‡æ•°æ®åº“)       â”‚
                          â”‚  localhost:1933       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.2 è®°å¿†å·¥å…·è¯¦è§£

```python
# 1. å›å¿† â€” è¯­ä¹‰æœç´¢å†å²å¯¹è¯å’ŒçŸ¥è¯†
recall_memory(query="ç”¨æˆ·çš„ç¼–ç åå¥½", scope="user", limit=5)
# scope: "user"(ç”¨æˆ·çº§) / "session"(ä¼šè¯çº§) / "project"(é¡¹ç›®çº§)

# 2. ä¿å­˜ â€” æŒä¹…åŒ–é‡è¦ä¿¡æ¯ï¼ˆç”± LLM ä¸»åŠ¨åˆ¤æ–­ä½•æ—¶ä¿å­˜ï¼‰
save_memory(content="ç”¨æˆ·åå¥½ Python type hints å’Œ dataclass", category="preferences")

# 3. æµè§ˆ â€” æ–‡ä»¶ç³»ç»Ÿå¼æµè§ˆè®°å¿†åº“
explore_memory(uri="/users/sawzhang/preferences", recursive=True)

# 4. çŸ¥è¯†ç´¢å¼• â€” å°†æœ¬åœ°æ–‡ä»¶å†…å®¹ç´¢å¼•åˆ°è®°å¿†åº“
add_knowledge(path="/path/to/architecture.md", reason="é¡¹ç›®æ¶æ„å‚è€ƒ")
```

#### 3.4.3 é€æ˜ç”Ÿå‘½å‘¨æœŸç®¡ç†

Memory ç³»ç»Ÿé€šè¿‡ EventBus é’©å­å®ç°å®Œå…¨é€æ˜çš„è®°å¿†ç®¡ç†ï¼š

```
AGENT_START â†’ è‡ªåŠ¨åˆ›å»º OpenViking session
     â”‚
     â–¼
æ¯æ¬¡ CONTEXT_TRANSFORM â†’ å¢é‡åŒæ­¥æ–°æ¶ˆæ¯åˆ° OpenViking
     â”‚                   ï¼ˆé¿å…ä¸Šä¸‹æ–‡å‹ç¼©æ—¶ä¸¢å¤±å†å²ï¼‰
     â–¼
AGENT_END â†’ åŒæ­¥å‰©ä½™æ¶ˆæ¯ + commitï¼ˆè§¦å‘çŸ¥è¯†æå–ï¼‰
```

**å…³é”®è®¾è®¡**ï¼š`_synced_message_count` è¿½è¸ªå·²åŒæ­¥æ•°é‡ï¼ŒåªåŒæ­¥å¢é‡ï¼Œé¿å…é‡å¤ã€‚

---

### 3.5 MCP / Extensions æ‰©å±•ä½“ç³»

Extensions æ˜¯ SkillKit çš„æ’ä»¶ç³»ç»Ÿï¼Œè¿æ¥ MCP æœåŠ¡å™¨å’Œè‡ªå®šä¹‰å·¥å…·ã€‚

#### 3.5.1 Extensions vs Skills vs Tools çš„åŒºåˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          èƒ½åŠ›æ¥æºçŸ©é˜µ                            â”‚
â”‚                                                                 â”‚
â”‚  Skills (çŸ¥è¯†å±‚)     â†’ æ³¨å…¥ system promptï¼Œæ•™æ¨¡å‹åšäº‹           â”‚
â”‚  â”œâ”€ bigquery skill   â†’ "ç”¨ bq å‘½ä»¤æŸ¥ BigQuery"                â”‚
â”‚  â””â”€ pdf skill        â†’ "ç”¨ poppler å·¥å…·å¤„ç† PDF"              â”‚
â”‚                                                                 â”‚
â”‚  Tools (æ‰§è¡Œå±‚)      â†’ function callingï¼Œæ¨¡å‹ç›´æ¥è°ƒç”¨           â”‚
â”‚  â”œâ”€ execute          â†’ å†…ç½®ï¼šæ‰§è¡Œ bash å‘½ä»¤                    â”‚
â”‚  â”œâ”€ recall_memory    â†’ Extension æ³¨å†Œï¼šæœç´¢è®°å¿†                â”‚
â”‚  â””â”€ search_jira      â†’ Extension æ³¨å†Œï¼šæœç´¢ Jira             â”‚
â”‚                                                                 â”‚
â”‚  MCP Servers (è¿æ¥å±‚) â†’ è¿œç¨‹æœåŠ¡å™¨æä¾›çš„å·¥å…·                     â”‚
â”‚  â”œâ”€ Zapier MCP       â†’ è‡ªåŠ¨åŒ–å·¥ä½œæµ                            â”‚
â”‚  â”œâ”€ Database MCP     â†’ æ•°æ®åº“æŸ¥è¯¢                              â”‚
â”‚  â””â”€ Custom API MCP   â†’ è‡ªå®šä¹‰ API å°è£…                         â”‚
â”‚                                                                 â”‚
â”‚  Extensions (é›†æˆå±‚)  â†’ æ³¨å†Œå·¥å…·ã€å‘½ä»¤ã€é’©å­çš„æ’ä»¶               â”‚
â”‚  â”œâ”€ memory extension â†’ æ³¨å†Œ 4 ä¸ª memory tools + 3 ä¸ª hooks    â”‚
â”‚  â”œâ”€ jira extension   â†’ æ³¨å†Œ search/create/update tools        â”‚
â”‚  â””â”€ theme extension  â†’ æ³¨å†Œ theme å‘½ä»¤                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.5.2 Extension API

```python
class ExtensionAPI:
    """Extension å¯ä»¥ä½¿ç”¨çš„æ¥å£"""
    def register_tool(self, tool: ToolInfo): ...       # æ³¨å†Œ function calling å·¥å…·
    def register_command(self, cmd: CommandInfo): ...   # æ³¨å†Œ /command
    def get_event_bus(self) -> EventBus: ...            # è·å–äº‹ä»¶æ€»çº¿
    def get_engine(self) -> SkillsEngine: ...           # è·å–æŠ€èƒ½å¼•æ“

class ToolInfo:
    name: str              # å·¥å…·åï¼ˆLLM å¯è§ï¼‰
    description: str       # åŠŸèƒ½æè¿°
    parameters: dict       # JSON Schema
    handler: Callable      # async handler(args) â†’ str

class CommandInfo:
    name: str              # å‘½ä»¤åï¼ˆå¦‚ "status"ï¼‰
    description: str       # æè¿°
    handler: Callable      # å¤„ç†å‡½æ•°
    source: str            # æ¥æºæ ‡è¯†
```

#### 3.5.3 Memory æ¥å…¥ç¤ºä¾‹ï¼ˆExtension çš„å®Œæ•´æ¥å…¥æ¨¡å¼ï¼‰

```python
async def setup_memory(agent: AgentRunner, config: MemoryConfig):
    """Memory ç³»ç»Ÿé€šè¿‡ Extension æœºåˆ¶æ¥å…¥ Agent â€” ä½“ç°äº†æ’ä»¶åŒ–è®¾è®¡"""

    # 1. åˆ›å»ºå®¢æˆ·ç«¯ + å¥åº·æ£€æŸ¥
    client = OpenVikingClient(config.base_url, config.api_key)
    if not await client.available:
        return None  # ä¼˜é›…é™çº§ï¼šMemory ä¸å¯ç”¨æ—¶ Agent æ­£å¸¸è¿è¡Œ

    # 2. åˆå§‹åŒ–æ‰©å±•ç®¡ç†å™¨
    ext_manager = agent.engine.init_extensions()

    # 3. æ³¨å†Œ 4 ä¸ª memory toolsï¼ˆLLM é€šè¿‡ function calling è°ƒç”¨ï¼‰
    state = MemoryState(client=client)
    for tool_factory in [make_recall_tool, make_save_tool,
                         make_explore_tool, make_knowledge_tool]:
        ext_manager.register_tool(tool_factory(state))

    # 4. æ³¨å†Œ 3 ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆé€æ˜è¿è¡Œï¼Œæ— éœ€ LLM æ„ŸçŸ¥ï¼‰
    hooks = MemoryHooks(client, state)
    bus = agent.events
    bus.on(AGENT_START, hooks.on_agent_start, priority=10)      # åˆ›å»º session
    bus.on(CONTEXT_TRANSFORM, hooks.on_context_transform, priority=100)  # å¢é‡åŒæ­¥
    bus.on(AGENT_END, hooks.on_agent_end, priority=90)          # æäº¤+æå–

    return client
```

---

## 4. æ”¯æ’‘ä½“ç³»

### 4.1 äº‹ä»¶æ€»çº¿ä¸ Hooks (EventBus)

EventBus æ˜¯æ•´ä¸ªç³»ç»Ÿçš„"ç¥ç»ç½‘ç»œ"ï¼Œæ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶é€šè¿‡å®ƒä¼ æ’­ï¼Œæ”¯æŒæ‹¦æˆªå’Œä¿®æ”¹ã€‚

```python
class EventBus:
    def on(self, event: str, handler, priority: int = 0, source: str = ""):
        """æ³¨å†Œå¤„ç†å™¨ã€‚priority è¶Šå°è¶Šå…ˆæ‰§è¡Œã€‚æ”¯æŒ sync å’Œ async handler"""
        ...
    async def emit(self, event: str, data) -> list[Any]:
        """è§¦å‘äº‹ä»¶ï¼ŒæŒ‰ä¼˜å…ˆçº§è°ƒç”¨æ‰€æœ‰ handlerï¼Œæ”¶é›†è¿”å›å€¼"""
        ...
    def off_by_source(self, source: str) -> int:
        """æŒ‰æ¥æºæ‰¹é‡ç§»é™¤ handlerï¼ˆExtension å¸è½½æ—¶ç”¨ï¼‰"""
        ...
```

**å®Œæ•´äº‹ä»¶ç”Ÿå‘½å‘¨æœŸï¼š**

| äº‹ä»¶ | è§¦å‘æ—¶æœº | Handler è¿”å›å€¼èƒ½åšä»€ä¹ˆ |
|------|---------|---------------------|
| `INPUT` | ç”¨æˆ·è¾“å…¥ | `action="transform"` æ”¹å†™è¾“å…¥ / `action="handled"` ç›´æ¥å“åº” |
| `AGENT_START` | Agent å¼€å§‹å¤„ç† | åˆå§‹åŒ–èµ„æºï¼ˆMemory session ç­‰ï¼‰ |
| `TURN_START` | æ¯æ¬¡ LLM è°ƒç”¨å‰ | è®°å½•è½®æ¬¡ä¿¡æ¯ |
| `CONTEXT_TRANSFORM` | æ¶ˆæ¯å‘é€ç»™ LLM å‰ | **æ³¨å…¥/åˆ å‡/é‡æ’æ¶ˆæ¯** |
| `TURN_END` | LLM è¿”å›å | åˆ†æå“åº”ã€ç»Ÿè®¡ |
| `BEFORE_TOOL_CALL` | å·¥å…·æ‰§è¡Œå‰ | **é˜»æ­¢æ‰§è¡Œ** / **ä¿®æ”¹å‚æ•°**ï¼ˆguard railsï¼‰ |
| `AFTER_TOOL_RESULT` | å·¥å…·æ‰§è¡Œå | **ä¿®æ”¹ç»“æœ**ï¼ˆå®¡è®¡/è¿‡æ»¤ï¼‰ |
| `TOOL_EXECUTION_UPDATE` | å·¥å…·å®æ—¶è¾“å‡º | æµå¼å±•ç¤ºè¿›åº¦ |
| `AGENT_END` | Agent å®Œæˆ | æ¸…ç†èµ„æºã€æäº¤è®°å¿† |
| `SESSION_START/END` | ä¼šè¯ç”Ÿå‘½å‘¨æœŸ | æŒä¹…åŒ–ç®¡ç† |
| `MODEL_CHANGE` | æ¨¡å‹åˆ‡æ¢ | è®°å½•å˜æ›´ |
| `COMPACTION` | ä¸Šä¸‹æ–‡å‹ç¼© | åŒæ­¥è®°å¿†åˆ°å¤–éƒ¨å­˜å‚¨ |

**Hooks å®æˆ˜ç¤ºä¾‹ï¼ˆGuard Railsï¼‰ï¼š**

```python
# Guard Rail: é˜»æ­¢å±é™©å‘½ä»¤
@bus.on(BEFORE_TOOL_CALL, priority=0)
async def safety_guard(event: BeforeToolCallEvent):
    cmd = event.args.get("command", "")
    if any(danger in cmd for danger in ["rm -rf /", "DROP TABLE", "format c:"]):
        return ToolCallEventResult(block=True, reason="Dangerous command blocked")

# Logging: è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨
@bus.on(AFTER_TOOL_RESULT, priority=100)
async def audit_log(event: AfterToolResultEvent):
    log.info(f"Tool: {event.tool_name}, Duration: {event.turn}ms")

# Human-in-the-loop: æ•æ„Ÿæ“ä½œç¡®è®¤
@bus.on(BEFORE_TOOL_CALL, priority=5)
async def require_approval(event: BeforeToolCallEvent):
    if "deploy" in event.args.get("command", ""):
        approved = await ask_user_confirmation("Deploy command detected. Proceed?")
        if not approved:
            return ToolCallEventResult(block=True, reason="User denied deployment")

# Context Injection: åŠ¨æ€æ³¨å…¥é¡¹ç›®è§„åˆ™
@bus.on(CONTEXT_TRANSFORM, priority=50)
async def inject_rules(event: ContextTransformEvent):
    messages = list(event.messages)
    messages.insert(1, AgentMessage(role="system", content="Rule: Always use Python 3.12+"))
    return ContextTransformEventResult(messages=messages)
```

---

### 4.2 ä¸Šä¸‹æ–‡ç®¡ç† (ContextManager)

ç®¡ç† LLM ä¸Šä¸‹æ–‡çª—å£é¢„ç®—ï¼Œé˜²æ­¢é•¿å¯¹è¯è¶…å‡ºé™åˆ¶ã€‚

```python
class ContextManager:
    context_window: int = 128_000     # æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£å¤§å°
    reserve_tokens: int = 4096        # è¾“å‡ºé¢„ç•™ token
    threshold: float = 0.9            # ä½¿ç”¨ç‡è¾¾åˆ° 90% æ—¶è§¦å‘å‹ç¼©
    compactor: ContextCompactor       # å‹ç¼©ç­–ç•¥

    @property
    def budget_tokens(self) -> int:
        return self.context_window - self.reserve_tokens

    def should_compact(self, messages) -> bool:
        return self.usage_fraction(messages) >= self.threshold
```

**ä¸¤ç§å‹ç¼©ç­–ç•¥ï¼š**

```
ç­–ç•¥ 1: TokenBudgetCompactorï¼ˆé»˜è®¤ï¼‰
  åŸå§‹: [sys] [u1] [a1] [u2] [a2] [u3] [a3] [u4] [a4]  â† è¶…å‡º 90%
  å‹ç¼©: [sys]                    [u3] [a3] [u4] [a4]     â† ä»å‰å¾€ååˆ é™¤

ç­–ç•¥ 2: SlidingWindowCompactorï¼ˆä¿ç•™æœ€è¿‘ N è½®ï¼‰
  è®¾ç½®: max_turns = 3
  åŸå§‹: [sys] [u1] [a1] [u2] [a2] [u3] [a3] [u4] [a4]
  å‹ç¼©: [sys]           [u2] [a2] [u3] [a3] [u4] [a4]   â† ä¿ç•™æœ€è¿‘ 3 è½®
```

**Token ä¼°ç®—**ï¼š`estimate_tokens(text) â†’ len(text) / 4`ï¼ˆå¯å‘å¼è¿‘ä¼¼ï¼‰

---

### 4.3 ä¼šè¯æŒä¹…åŒ– (Session)

åŸºäº JSONL çš„ append-only ä¼šè¯å­˜å‚¨ï¼Œæ”¯æŒ**åˆ†æ”¯å¯¹è¯æ ‘**ã€‚

#### å­˜å‚¨ç»“æ„

```
~/.skillkit/sessions/{cwd-hash-16}/
  â”œâ”€â”€ {session-id-1}.jsonl
  â””â”€â”€ {session-id-2}.jsonl    â† fork äº§ç”Ÿçš„åˆ†æ”¯ä¼šè¯
```

#### æ¡ç›®ç±»å‹ï¼ˆ8 ç§ï¼‰

```json
{"type": "header", "id": "h1", "version": 1, "cwd": "/project"}
{"type": "message", "id": "m1", "parent_id": "h1", "role": "user", "content": "Fix bug"}
{"type": "message", "id": "m2", "parent_id": "m1", "role": "assistant", "content": "..."}
{"type": "model_change", "id": "mc1", "parent_id": "m2", "new_model": "claude-opus-4-6"}
{"type": "compaction", "id": "c1", "parent_id": "mc1", "summary": "...", "tokens_before": 50000}
{"type": "branch_summary", "id": "b1", "from_id": "m2", "summary": "æ¢ç´¢äº†å¦ä¸€ç§æ–¹æ¡ˆ"}
{"type": "label", "id": "l1", "target_id": "m3", "label": "checkpoint-before-refactor"}
{"type": "custom", "id": "x1", "custom_type": "analysis", "data": {...}}
```

#### åˆ†æ”¯ï¼ˆForkï¼‰ä¸æ—¶é—´æ—…è¡Œ

```
       h1 â”€â”€â”€ m1 â”€â”€â”€ m2 â”€â”€â”€ m3 â”€â”€â”€ m4  (ä¸»çº¿)
                        â”‚
                        â””â”€â”€ m5 â”€â”€â”€ m6    (åˆ†æ”¯ï¼šä» m2 å¼€å§‹çš„æ–°æ–¹å‘)

# åˆ›å»ºåˆ†æ”¯
new_session = session_manager.fork(entry_id="m2")

# å›åˆ°è¿‡å»æŸä¸ªç‚¹
session_manager.navigate(entry_id="m2")  # ç§»åŠ¨ leaf æŒ‡é’ˆ
```

---

### 4.4 åŒ…ç®¡ç† (Packages)

å¤šæ¥æº Skill/Extension/Theme/Prompt çš„å‘ç°å’Œè§£æã€‚

```python
class PackageManager:
    user_dir   = ~/.skillkit/packages/     # ç”¨æˆ·çº§ï¼ˆå…¨å±€ï¼‰
    project_dir = ./.skillkit/packages/    # é¡¹ç›®çº§

    def resolve(self, sources=None) -> list[ResolvedPackage]:
        """è‡ªåŠ¨å‘ç° + æ‰‹åŠ¨æŒ‡å®šæ¥æº"""
        # 1. æ‰«æ user_dir å’Œ project_dir
        # 2. è§£æ cwd çš„ pyproject.toml
        # 3. è§£ææ˜¾å¼ sources
```

**æ¥æºç±»å‹ï¼š**
```python
parse_source("./my-skills/")                              â†’ local
parse_source("my-skill-pack")                             â†’ pypi
parse_source("git+https://github.com/user/skills.git")    â†’ git
```

**Manifestï¼ˆ`pyproject.toml`ï¼‰ï¼š**
```toml
[tool.skillkit]
skills = ["skills/**"]
extensions = ["ext/**/*.py"]
themes = ["themes/*.yaml"]
prompts = ["prompts/*.md"]
```

---

### 4.5 è·¨æ¨¡å‹é€‚é… (Adapters)

è¿è¡Œæ—¶åˆ‡æ¢ LLM æä¾›å•†ï¼Œè‡ªåŠ¨å¤„ç†æ¶ˆæ¯æ ¼å¼å·®å¼‚ã€‚

```python
# è¿è¡Œæ—¶åˆ‡æ¢
agent.switch_model("claude-opus-4-6", adapter_name="anthropic")

# æ¶ˆæ¯è‡ªåŠ¨è½¬æ¢
transform_messages(messages, target_provider="anthropic", source_provider="openai")
```

**è‡ªåŠ¨å¤„ç†çš„å·®å¼‚ï¼š**

| å·®å¼‚ | OpenAI | Anthropic | è½¬æ¢ç­–ç•¥ |
|------|--------|-----------|---------|
| Tool Call ID é•¿åº¦ | 450+ å­—ç¬¦ | æœ€å¤§ 64 | SHA-256 å“ˆå¸Œæˆªæ–­ |
| Thinking blocks | ä¸æ”¯æŒ | åŸç”Ÿæ”¯æŒ | è½¬ä¸º text å‰ç¼€ |
| System message | messages æ•°ç»„ä¸­ | ç‹¬ç«‹ system å‚æ•° | è‡ªåŠ¨æå– |
| å­¤ç«‹ tool_calls | å¯èƒ½å‡ºç° | å¿…é¡»æœ‰ result | æ’å…¥åˆæˆç©º result |
| Thinking budget | reasoning_effort | adaptive thinking | ç»Ÿä¸€ ThinkingLevel æ˜ å°„ |

**ThinkingLevel ç»Ÿä¸€æ˜ å°„ï¼š**
```
ThinkingLevel:  off â†’ minimal â†’ low â†’ medium â†’ high â†’ xhigh
Anthropic:      (æ— )   low      low   medium   high   max
OpenAI:         (æ— )   low      low   medium   high   high
Token Budget:    0     1024    2048   8192    16384  16384
```

---

### 4.6 TUI ç»ˆç«¯ç•Œé¢ä½“ç³»

å®Œæ•´çš„ç»ˆç«¯ UI æ¡†æ¶ï¼Œä»é›¶æ„å»ºï¼ˆä¸ä¾èµ– curses/blessedï¼‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                TUI Architecture                 â”‚
â”‚                                                â”‚
â”‚  TUIRenderer (å·®åˆ†æ¸²æŸ“å¼•æ“)                     â”‚
â”‚  â”œâ”€ åªé‡ç»˜å˜åŒ–çš„è¡Œ                              â”‚
â”‚  â”œâ”€ DEC 2026 åŒæ­¥è¾“å‡ºï¼ˆæ— æ’•è£‚ï¼‰                 â”‚
â”‚  â””â”€ ç»ˆç«¯å¤§å°å˜åŒ–è‡ªåŠ¨é‡ç»˜                        â”‚
â”‚                                                â”‚
â”‚  Container (å‚ç›´å®¹å™¨)                           â”‚
â”‚  â”œâ”€ MarkdownWidget (åªè¯» Markdown æ¸²æŸ“)        â”‚
â”‚  â”œâ”€ InputWidget (å•è¡Œè¾“å…¥ + readline å¿«æ·é”®)   â”‚
â”‚  â”œâ”€ EditorWidget (å¤šè¡Œç¼–è¾‘å™¨ + è‡ªåŠ¨æ¢è¡Œ)       â”‚
â”‚  â”œâ”€ SelectList (åˆ—è¡¨é€‰æ‹© + æ¨¡ç³Šè¿‡æ»¤)          â”‚
â”‚  â””â”€ Overlay (æ¨¡æ€å¼¹çª—æ ˆ)                       â”‚
â”‚                                                â”‚
â”‚  AutoComplete (è‡ªåŠ¨è¡¥å…¨)                        â”‚
â”‚  â”œâ”€ FileAutocomplete (@æ–‡ä»¶è·¯å¾„)               â”‚
â”‚  â”œâ”€ CommandAutocomplete (/å‘½ä»¤)                â”‚
â”‚  â””â”€ CombinedAutocomplete (ç»„åˆ)                â”‚
â”‚                                                â”‚
â”‚  KeybindingsManager (å¿«æ·é”®)                   â”‚
â”‚  â”œâ”€ å¯è‡ªå®šä¹‰ ~/.skillkit/keybindings.json      â”‚
â”‚  â””â”€ é»˜è®¤: Ctrl+C ä¸­æ–­, Ctrl+L æ¸…å±, etc.     â”‚
â”‚                                                â”‚
â”‚  Theme (ä¸»é¢˜ç³»ç»Ÿ)                               â”‚
â”‚  â”œâ”€ 53 ä¸ªé¢œè‰²é”® (core/message/markdown/syntax) â”‚
â”‚  â”œâ”€ JSON + å˜é‡å¼•ç”¨                            â”‚
â”‚  â””â”€ å‘ç°: ~/.skillkit/themes/ + .skillkit/     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»é¢˜å˜é‡è§£æ**ï¼ˆå·§å¦™çš„é¢œè‰²å¤ç”¨æœºåˆ¶ï¼‰ï¼š
```json
{
  "name": "catppuccin-mocha",
  "variables": {
    "base": "#1e1e2e",
    "blue": "#89b4fa",
    "text": "#cdd6f4"
  },
  "colors": {
    "background": "base",       â† å¼•ç”¨ variables ä¸­çš„ "base"
    "primary": "text",          â† å¼•ç”¨ variables ä¸­çš„ "text"
    "accent": "blue",           â† å¼•ç”¨ variables ä¸­çš„ "blue"
    "error": "#f38ba8"          â† ç›´æ¥ä½¿ç”¨ hex å€¼
  }
}
```

---

### 4.7 Prompt Caching ç¼“å­˜ç­–ç•¥

é’ˆå¯¹ä¸åŒ LLM æä¾›å•†çš„ç¼“å­˜é…ç½®ï¼š

```python
# Anthropic: åˆ©ç”¨ ephemeral cache_control
cache_retention="short"  â†’ {"type": "ephemeral"}              # é»˜è®¤ TTL
cache_retention="long"   â†’ {"type": "ephemeral", "ttl": "1h"} # 1 å°æ—¶

# OpenAI: åˆ©ç”¨ prompt_cache_key
cache_retention="short"  â†’ {"prompt_cache_key": session_id}
cache_retention="long"   â†’ {"prompt_cache_key": session_id, "prompt_cache_retention": "24h"}
```

**ç¼“å­˜å¯¹ Skill First çš„ä»·å€¼**ï¼š
- System prompt ä¸­çš„ Skills å†…å®¹åœ¨å¤šè½®å¯¹è¯ä¸­ä¿æŒä¸å˜
- Anthropic çš„ prompt caching å¯ä»¥å¤§å¹…å‡å°‘é‡å¤ä¼ è¾“çš„ token è´¹ç”¨
- `SkillSnapshot.version` ç¡®ä¿ Skill å˜åŒ–æ—¶ç¼“å­˜æ­£ç¡®å¤±æ•ˆ

---

## 5. å®Œæ•´æ‰§è¡Œæµç¨‹ï¼šSkill çš„åŠ¨æ€åŠ è½½ä¸è¿è¡Œ

ä»¥ä¸‹ä»¥ **"å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub Issueï¼Œæ ‡é¢˜æ˜¯ 'Fix login bug'"** ä¸ºä¾‹ï¼Œå±•ç¤ºå®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹ã€‚

### Phase 1: åˆå§‹åŒ–

```python
agent = await create_agent(
    skill_dirs=[Path("~/.skillkit/skills"), Path("./skills")],
    system_prompt="You are a helpful coding assistant.",
    model="claude-sonnet-4-20250514",
)
# å¯é€‰ï¼šæ¥å…¥ Memory ç³»ç»Ÿ
client = await setup_memory(agent, MemoryConfig())
```

**å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼š**
```
AgentRunner.__init__()
 â”œâ”€ SkillsEngine(config, loader, filter, runtime)
 â”‚   â”œâ”€ loader = MarkdownSkillLoader()
 â”‚   â”œâ”€ filter = DefaultSkillFilter()
 â”‚   â””â”€ runtime = BashRuntime(shell="/bin/bash", default_timeout=30s, max_output=1MB)
 â”œâ”€ EventBus()
 â”œâ”€ ContextManager(context_window=200000, threshold=0.9)
 â”œâ”€ AdapterRegistry() â†’ æ³¨å†Œ OpenAI + Anthropic adapters
 â””â”€ load_context_files() â†’ å‘ä¸Šéå†æ‰¾ AGENTS.md / CLAUDE.md

setup_memory()
 â”œâ”€ OpenVikingClient â†’ HTTP å¥åº·æ£€æŸ¥
 â”œâ”€ ExtensionManager.register_tool() Ã— 4 (recall/save/explore/knowledge)
 â””â”€ EventBus.on() Ã— 3 (agent_start/context_transform/agent_end)
```

### Phase 2: Skill åŠ¨æ€åŠ è½½ï¼ˆget_snapshot é¦–æ¬¡è°ƒç”¨ï¼‰

```
engine.get_snapshot(force_reload=False)
  â”‚
  â”‚  ç¼“å­˜ä¸ºç©º â†’ è§¦å‘å®Œæ•´åŠ è½½
  â”‚
  â”œâ”€ load_skills()
  â”‚   â”œâ”€ æ‰«æ ~/.skillkit/skills/
  â”‚   â”‚   â”œâ”€ github/SKILL.md
  â”‚   â”‚   â”‚   â”œâ”€ è¯»å–æ–‡ä»¶å†…å®¹ (1.2KB)
  â”‚   â”‚   â”‚   â”œâ”€ æ­£åˆ™åˆ†ç¦»: --- YAML --- + Markdown body
  â”‚   â”‚   â”‚   â”œâ”€ yaml.safe_load(frontmatter)
  â”‚   â”‚   â”‚   â”œâ”€ è§£æ metadata:
  â”‚   â”‚   â”‚   â”‚   emoji="ğŸ™", primary_env="GITHUB_TOKEN"
  â”‚   â”‚   â”‚   â”‚   requires.bins=["gh"]
  â”‚   â”‚   â”‚   â”‚   requires.env=["GITHUB_TOKEN"]
  â”‚   â”‚   â”‚   â”œâ”€ è§£æ actions: create-issue â†’ scripts/create-issue.sh
  â”‚   â”‚   â”‚   â””â”€ â†’ Skill(name="github", source=MANAGED, content_hash="a3f2b1...")
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€ docker/SKILL.md â†’ Skill(name="docker", source=MANAGED)
  â”‚   â”‚   â””â”€ python/SKILL.md â†’ Skill(name="python", source=MANAGED)
  â”‚   â”‚
  â”‚   â””â”€ æ‰«æ ./skills/
  â”‚       â””â”€ my-tool/SKILL.md â†’ Skill(name="my-tool", source=WORKSPACE)
  â”‚
  â”œâ”€ filter_skills([github, docker, python, my-tool], context)
  â”‚   â”‚
  â”‚   â”‚  context = FilterContext(
  â”‚   â”‚    platform="darwin",
  â”‚   â”‚    available_bins={"gh", "python3", "node", ...},
  â”‚   â”‚    env_vars={"GITHUB_TOKEN": "ghp_xxx", "PATH": "...", ...},
  â”‚   â”‚    config_values={}
  â”‚   â”‚  )
  â”‚   â”‚
  â”‚   â”œâ”€ github:
  â”‚   â”‚   â‘  always=false â†’ ç»§ç»­
  â”‚   â”‚   â‘¡ enabled? â†’ æ²¡æœ‰é…ç½®ç¦ç”¨ â†’ ç»§ç»­
  â”‚   â”‚   â‘¢ åœ¨ exclude_skills? â†’ ä¸åœ¨ â†’ ç»§ç»­
  â”‚   â”‚   â‘£ bundled allowlist? â†’ é bundled â†’ è·³è¿‡æ£€æŸ¥
  â”‚   â”‚   â‘¤ os=["darwin", "linux"] â†’ å½“å‰ darwin âœ“
  â”‚   â”‚   â‘¥ bins=["gh"] â†’ shutil.which("gh") âœ“ å­˜åœ¨
  â”‚   â”‚   â‘¦ any_bins=[] â†’ æ— è¦æ±‚ âœ“
  â”‚   â”‚   â‘§ env=["GITHUB_TOKEN"] â†’ os.environ ä¸­å­˜åœ¨ âœ“
  â”‚   â”‚   â‘¨ config=[] â†’ æ— è¦æ±‚ âœ“
  â”‚   â”‚   â†’ åˆæ ¼ âœ“
  â”‚   â”‚
  â”‚   â”œâ”€ docker:
  â”‚   â”‚   â‘¥ bins=["docker"] â†’ shutil.which("docker") â†’ None âœ—
  â”‚   â”‚   â†’ ä¸åˆæ ¼ (reason: "missing required binary: docker")
  â”‚   â”‚
  â”‚   â”œâ”€ python: â†’ åˆæ ¼ âœ“
  â”‚   â””â”€ my-tool: â†’ åˆæ ¼ âœ“
  â”‚
  â”œâ”€ format_prompt([github, python, my-tool], format="xml")
  â”‚   â””â”€ _format_xml() â†’ "<skills><skill name='github'>...</skill>...</skills>"
  â”‚
  â””â”€ â†’ SkillSnapshot(
       skills=[github, python, my-tool],     # 3 ä¸ªåˆæ ¼ Skill
       prompt="<skills>...(~3KB)...",         # é¢„æ ¼å¼åŒ– XML
       version=1,                             # ç‰ˆæœ¬å·ï¼ˆç¼“å­˜é”®ï¼‰
       timestamp=1708000000.0
     )
```

### Phase 3: æ„å»ºå®Œæ•´ System Prompt

```python
agent.build_system_prompt()
```

```
æœ€ç»ˆ system prompt ç»„æˆ:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åŸºç¡€ System Prompt                               â”‚
â”‚  "You are a helpful coding assistant."               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. Context Files (è‡ªåŠ¨å‘ç°, æŒ‰ä¼˜å…ˆçº§æ’åˆ—)            â”‚
â”‚  # ~/.skillkit/AGENTS.md (å…¨å±€)                      â”‚
â”‚  "Always use Python 3.12+ ..."                       â”‚
â”‚  # ./CLAUDE.md (é¡¹ç›®çº§, æ›´é«˜ä¼˜å…ˆçº§)                   â”‚
â”‚  "This project uses FastAPI + PostgreSQL ..."        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. Skills Prompt (é¢„æ ¼å¼åŒ– XML)                     â”‚
â”‚  <skills>                                            â”‚
â”‚    <skill name="github" emoji="ğŸ™">                  â”‚
â”‚      <description>Interact with GitHub...</descriptionâ”‚
â”‚      <content>                                        â”‚
â”‚        You have access to the GitHub CLI (`gh`)...   â”‚
â”‚        ## Common Operations                          â”‚
â”‚        - List issues: `gh issue list`                â”‚
â”‚        - Create PR: `gh pr create ...`               â”‚
â”‚      </content>                                      â”‚
â”‚    </skill>                                          â”‚
â”‚    <skill name="python">...</skill>                  â”‚
â”‚    <skill name="my-tool">...</skill>                 â”‚
â”‚  </skills>                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 4: ç”¨æˆ·è¯·æ±‚ â†’ Agent Loop

```python
response = await agent.chat("å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub Issueï¼Œæ ‡é¢˜æ˜¯ 'Fix login bug'")
```

```
â”€â”€â”€ Step 1: INPUT äº‹ä»¶ â”€â”€â”€
emit(INPUT, InputEvent(user_input="å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub Issue..."))
  â””â”€ æ—  handler æ‹¦æˆª â†’ action="continue"
_check_skill_invocation("å¸®æˆ‘åˆ›å»º...") â†’ Noneï¼ˆä¸ä»¥ / å¼€å¤´ï¼‰
history.append(AgentMessage(role="user", content="å¸®æˆ‘åˆ›å»º..."))

â”€â”€â”€ Step 2: AGENT_START â”€â”€â”€
emit(AGENT_START, AgentStartEvent(model="claude-sonnet-4-20250514", turn=0))
  â””â”€ MemoryHooks.on_agent_start â†’ client.create_session() â†’ session_id="sess_abc123"

â”€â”€â”€ Step 3: Turn 1 â€” è°ƒç”¨ LLM â”€â”€â”€
emit(TURN_START, TurnStartEvent(turn=1, message_count=2))
context_manager.should_compact(messages) â†’ False (usage=12% < 90%)
emit(CONTEXT_TRANSFORM, ContextTransformEvent(messages=[sys, user], turn=1))
  â””â”€ MemoryHooks.on_context_transform â†’ sync 2 new messages to OpenViking

_call_llm(messages=[system_prompt, user_message], stream=True)
  â””â”€ AnthropicAdapter.chat_stream_events()
      â”œâ”€ å°† tools=[execute, execute_script, read, write] + [recall_memory, ...] è½¬ä¸º Anthropic æ ¼å¼
      â”œâ”€ é™„åŠ  cache_control={"type": "ephemeral"} åˆ° system prompt
      â””â”€ client.messages.stream(...) â†’ AsyncIterator[StreamEvent]

LLM æ€è€ƒåè¿”å›:
  text: "æˆ‘æ¥å¸®ä½ åˆ›å»ºè¿™ä¸ª GitHub Issueã€‚è®©æˆ‘å…ˆç¡®è®¤ gh è®¤è¯çŠ¶æ€ã€‚"
  tool_calls: [{
    id: "toolu_01ABC",
    type: "function",
    function: {
      name: "execute",
      arguments: "{\"command\": \"gh auth status\", \"timeout\": 10}"
    }
  }]

emit(TURN_END, TurnEndEvent(turn=1, has_tool_calls=True, tool_call_count=1))

â”€â”€â”€ Step 4: å·¥å…·æ‰§è¡Œ â”€â”€â”€
emit(BEFORE_TOOL_CALL, BeforeToolCallEvent(
    tool_name="execute", args={"command": "gh auth status"}, turn=1))
  â””â”€ safety_guard handler â†’ ä¸å«å±é™©å‘½ä»¤ â†’ æ— æ‹¦æˆª

_execute_tool(tool_call):
  engine.execute(command="gh auth status", timeout=10)
    â””â”€ BashRuntime.execute()
        â”œâ”€ asyncio.create_subprocess_shell("gh auth status", ...)
        â”œâ”€ å¿«é€Ÿè·¯å¾„: process.communicate(timeout=10)
        â”œâ”€ exit_code=0, stdout="âœ“ Logged in to github.com as sawzhang"
        â””â”€ â†’ ExecutionResult(success=True, output="âœ“ Logged in...", duration_ms=423)

emit(AFTER_TOOL_RESULT, AfterToolResultEvent(
    tool_name="execute", result="âœ“ Logged in...", turn=1))

history.append(tool_result_message)

â”€â”€â”€ Step 5: Turn 2 â€” LLM è¯»å–ç»“æœ + æ‰§è¡Œåˆ›å»º â”€â”€â”€
emit(TURN_START, TurnStartEvent(turn=2, message_count=4))

LLM è¿”å›:
  text: "å·²ç¡®è®¤è®¤è¯çŠ¶æ€ã€‚ç°åœ¨åˆ›å»º Issueã€‚"
  tool_calls: [{
    function: {
      name: "execute",
      arguments: "{\"command\": \"gh issue create --title 'Fix login bug' --body 'Login functionality has a bug that needs to be fixed.' --repo sawzhang/myproject\"}"
    }
  }]

â†’ å·¥å…·æ‰§è¡Œ:
  BashRuntime: /bin/bash -c "gh issue create --title 'Fix login bug' ..."
  â†’ stdout: "https://github.com/sawzhang/myproject/issues/42"
  â†’ ExecutionResult(success=True, exit_code=0, duration_ms=1523)

â”€â”€â”€ Step 6: Turn 3 â€” LLM ç”Ÿæˆæœ€ç»ˆå›å¤ â”€â”€â”€
LLM è¿”å›:
  text: "å·²æˆåŠŸåˆ›å»º GitHub Issue #42ï¼\n\né“¾æ¥: https://github.com/sawzhang/myproject/issues/42\n\næ ‡é¢˜: 'Fix login bug'"
  tool_calls: []  â† æ— æ›´å¤šå·¥å…·è°ƒç”¨

emit(TURN_END, TurnEndEvent(turn=3, has_tool_calls=False))

â”€â”€â”€ Step 7: å®Œæˆ â”€â”€â”€
æ—  tool_calls + æ—  steering + æ—  follow_up â†’ é€€å‡ºå¾ªç¯

emit(AGENT_END, AgentEndEvent(
    total_turns=3, finish_reason="complete", user_input="å¸®æˆ‘åˆ›å»º..."))
  â””â”€ MemoryHooks.on_agent_end:
      â”œâ”€ sync remaining 3 messages to OpenViking
      â””â”€ client.commit_session("sess_abc123") â†’ è§¦å‘çŸ¥è¯†æå–

â†’ è¿”å› AgentMessage(
    role="assistant",
    content="å·²æˆåŠŸåˆ›å»º GitHub Issue #42ï¼...",
    token_usage=TokenUsage(input=3200, output=180, cache_read=2800)
  )
```

### Phase 5: çƒ­é‡è½½ï¼ˆåç»­ä¿®æ”¹ SKILL.md æ—¶ï¼‰

```
ç”¨æˆ·ç¼–è¾‘ skills/github/SKILL.md (æ·»åŠ æ–°å‘½ä»¤æç¤º)
  â”‚
  â–¼
watchfiles.awatch() æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
  â”‚
  â”œâ”€ 250ms é˜²æŠ–ç­‰å¾…ï¼ˆåˆå¹¶è¿ç»­ä¿å­˜ï¼‰
  â”‚
  â”œâ”€ è¿‡æ»¤: path.name == "SKILL.md" â†’ æ˜¯ç›¸å…³å˜åŒ–
  â”‚
  â”œâ”€ engine.invalidate_cache()
  â”‚   â””â”€ self._snapshot = None  # æ¸…é™¤ç¼“å­˜
  â”‚
  â””â”€ è§¦å‘å›è°ƒ â†’ é€šçŸ¥ UI æ˜¾ç¤º "Skills reloaded"
      â””â”€ ä¸‹æ¬¡ chat() è°ƒç”¨æ—¶:
          get_snapshot() â†’ ç¼“å­˜ä¸ºç©º â†’ é‡æ–°æ‰§è¡Œå®Œæ•´åŠ è½½ç®¡çº¿
          â†’ æ–° SkillSnapshot(version=2, ...)
```

---

## 6. é¡¹ç›®äº®ç‚¹ä¸åˆ›æ–°åˆ†æ

### 6.1 æ¶æ„åˆ›æ–°

| äº®ç‚¹ | è¯´æ˜ | å·¥ç¨‹ä»·å€¼ |
|------|------|---------|
| **Skill as Directory** | Skill ä¸æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ç›®å½•ï¼ˆSKILL.md + è¾…åŠ©èµ„æºï¼‰ | Agent å¯æŒ‰éœ€ `read` è¾…åŠ©æ–‡ä»¶ï¼Œå®ç°çŸ¥è¯†çš„æƒ°æ€§åŠ è½½ |
| **Filter Short-circuit** | 9 çº§èµ„æ ¼æ£€æŸ¥ï¼Œä»»ä¸€å¤±è´¥ç«‹å³è·³è¿‡ | æ¯«ç§’çº§è¿‡æ»¤ï¼Œé¿å…æ— æ•ˆ Skill è¿›å…¥ prompt |
| **Snapshot Immutability** | SkillSnapshot ä¸å¯å˜ + version è¿½è¸ª | å®‰å…¨ç¼“å­˜ï¼Œversion å˜åŒ–å³ç¼“å­˜å¤±æ•ˆ |
| **Content Hashing** | SHA-256 å“ˆå¸Œå‰ 16 ä½æ ‡è¯†å†…å®¹å˜åŒ– | ç²¾ç¡®æ£€æµ‹ Skill å†…å®¹å˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„é‡åŠ è½½ |
| **Thread-safe Env** | `contextvars.ContextVar` + `threading.Lock` | å¹¶å‘æ‰§è¡Œå¤šä¸ª Skill æ—¶äº’ä¸å¹²æ‰°çš„ç¯å¢ƒå˜é‡éš”ç¦» |

### 6.2 è®¾è®¡æ¨¡å¼ç²¾è¦

| æ¨¡å¼ | åº”ç”¨åœºæ™¯ | æ•ˆæœ |
|------|---------|------|
| **ç­–ç•¥æ¨¡å¼** | Loader/Filter/Runtime/Adapter å…¨éƒ¨å¯æ›¿æ¢ | 4 ä¸ªå­ç³»ç»Ÿå®Œå…¨å¯æ’æ‹” |
| **è§‚å¯Ÿè€…æ¨¡å¼** | EventBus äº‹ä»¶æ€»çº¿ | è§£è€¦æ ¸å¿ƒé€»è¾‘ä¸æ‰©å±•é€»è¾‘ |
| **ç®¡çº¿æ¨¡å¼** | Load â†’ Filter â†’ Format â†’ Cache â†’ Inject | æ¸…æ™°çš„æ•°æ®æµè½¬ |
| **ä¸Šä¸‹æ–‡ç®¡ç†å™¨** | env_context å®‰å…¨ç¯å¢ƒå˜é‡æ³¨å…¥/æ¢å¤ | é›¶æ³„æ¼çš„ç¯å¢ƒå˜é‡ç®¡ç† |
| **å·¥å‚æ–¹æ³•** | `create_agent()`, `AgentConfig.from_env()` | ç®€åŒ–åˆå§‹åŒ– |
| **è£…é¥°å™¨æ¨¡å¼** | `@bus.on(EVENT)` äº‹ä»¶æ³¨å†Œ | ä¼˜é›…çš„é’©å­æ³¨å†Œ |

### 6.3 Token ç»æµå­¦

```
ä¼ ç»Ÿ Tool First (100 ä¸ª tools):
  æ¯ä¸ª tool schema â‰ˆ 200 tokens
  100 tools Ã— 200 = 20,000 tokens/è¯·æ±‚ (ä»… tool å®šä¹‰)
  + æ¯æ¬¡è¯·æ±‚é‡ä¼ å…¨éƒ¨ schema

Skill First (4 ä¸ªåŸè¯­ + Skills prompt):
  4 ä¸ª tool schema â‰ˆ 800 tokens
  Skills prompt â‰ˆ 3,000 tokensï¼ˆä½†å¯ prompt cachingï¼‰
  é¦–æ¬¡: 3,800 tokens
  åç»­: 3,800 tokensï¼ˆAnthropic cache hit â†’ â‰ˆ380 tokens å®é™…è®¡è´¹ï¼‰

èŠ‚çœ: æ¯æ¬¡è¯·æ±‚èŠ‚çœ ~80% token è´¹ç”¨
```

### 6.4 å¯æ‰©å±•æ€§è®¾è®¡

```
æ·»åŠ æ–°èƒ½åŠ›çš„ä¸‰æ¡è·¯å¾„:

è·¯å¾„ 1: å†™ SKILL.mdï¼ˆé›¶ä»£ç ï¼Œæœ€ç®€å•ï¼‰
  â†’ æ•™ Agent æ–°çŸ¥è¯†/æœ€ä½³å®è·µ
  â†’ ä¾‹: æ·»åŠ  kubernetes skill = å†™ SKILL.md æè¿° kubectl ç”¨æ³•

è·¯å¾„ 2: æ³¨å†Œ Extension Toolï¼ˆéœ€è¦ä»£ç ï¼Œæ›´å¼ºæ§åˆ¶ï¼‰
  â†’ ç»™ Agent æ–°çš„ function calling tool
  â†’ ä¾‹: æ·»åŠ æ•°æ®åº“æŸ¥è¯¢ = æ³¨å†Œ query_db tool + handler

è·¯å¾„ 3: æ¥å…¥ MCP Serverï¼ˆè¿œç¨‹æœåŠ¡ï¼Œæœ€çµæ´»ï¼‰
  â†’ è¿æ¥è¿œç¨‹ API/æœåŠ¡
  â†’ ä¾‹: æ¥å…¥ Zapier MCP = è®¿é—® 5000+ åº”ç”¨çš„è‡ªåŠ¨åŒ–èƒ½åŠ›
```

### 6.5 ä¸ Claude Code çš„å¯¹ç…§

SkillKit çš„æ¶æ„å¯ä»¥çœ‹åˆ°è®¸å¤šä¸ Claude Code (Anthropic å®˜æ–¹ CLI) ç›¸ä¼¼çš„è®¾è®¡ç†å¿µï¼š

| ç‰¹æ€§ | Claude Code | SkillKit |
|------|------------|---------|
| æŠ€èƒ½ç³»ç»Ÿ | Slash commands + CLAUDE.md | SKILL.md + /command |
| å†…ç½®å·¥å…· | Read, Write, Edit, Bash, Grep... | execute, read, write + æ‰©å±• |
| ä¸Šä¸‹æ–‡ç®¡ç† | è‡ªåŠ¨å‹ç¼©å¯¹è¯ | ContextManager + å¤šç­–ç•¥ |
| äº‹ä»¶ç³»ç»Ÿ | Hooks (pre/post commit) | EventBus (12+ äº‹ä»¶ç±»å‹) |
| MCP æ”¯æŒ | MCP servers | Extensions + MCP |
| ä¼šè¯ç®¡ç† | å¯¹è¯å†å² | JSONL + åˆ†æ”¯æ ‘ |
| æ€è€ƒæ¨¡å¼ | Thinking levels | ThinkingLevel æ˜ å°„ |

**å·®å¼‚ç‚¹**ï¼šSkillKit çš„ Skill æ˜¯**æ›´å®Œæ•´çš„ç›®å½•ç»“æ„**ï¼ˆSKILL.md + è¾…åŠ©æ–‡ä»¶ + è„šæœ¬ï¼‰ï¼Œè€Œéå•çº¯çš„ prompt æ³¨å…¥ã€‚å®ƒæ”¯æŒ Actionsï¼ˆç¡®å®šæ€§è„šæœ¬æ‰§è¡Œï¼‰ï¼Œå¯ä»¥ç»•è¿‡ LLM ç›´æ¥æ‰§è¡Œé¢„å®šä¹‰æ“ä½œã€‚

---

## 7. ä¸å…¶ä»– Agent å“²å­¦çš„å¯¹æ¯”

| ç»´åº¦ | Tool First | Workflow First | **Skill First** | Conversation First |
|------|-----------|---------------|-----------------|-------------------|
| **ä»£è¡¨** | LangChain, Semantic Kernel | LangGraph, CrewAI, n8n | **SkillKit**, pi-mono | AutoGen, OpenAI Swarm |
| **æ ¸å¿ƒæ€è·¯** | ç»™å¤§é‡ toolsï¼Œæ¨¡å‹é€‰æ‹©è°ƒç”¨ | å»ºæ¨¡ä¸º DAG/å›¾/SOP | **æå°‘åŸè¯­ + Skill æ–‡ä»¶æ‰©å±•** | ä»£ç†é—´æ¶ˆæ¯åä½œ |
| **Prompt ä½“ç§¯** | å¤§ï¼ˆtool schema å¤šï¼‰ | ä¸­ï¼ˆæ­¥éª¤æè¿°ï¼‰ | **å°ï¼ˆSkill å†…å®¹ + ç¼“å­˜ï¼‰** | ä¸­ï¼ˆå¯¹è¯åè®®ï¼‰ |
| **Agent è‡ªä¸»æ€§** | ä¸­é«˜ï¼ˆé€‰å·¥å…·æ˜“æ··ä¹±ï¼‰ | ä½â†’ä¸­ï¼ˆå›¾/è§’è‰²é™åˆ¶å¼ºï¼‰ | **é«˜ï¼ˆè£¸ ReAct loopï¼‰** | ä¸­é«˜ï¼ˆå¯åŠ  supervisorï¼‰ |
| **Token æ•ˆç‡** | ä½ï¼ˆæ¯ä¸ª tool æœ‰ schemaï¼‰ | ä¸­ | **é«˜ï¼ˆprompt cachingï¼‰** | ä¸­ |
| **å¯æ§æ€§** | å¼±ï¼ˆæ¨¡å‹é€‰é”™å·¥å…·ï¼‰ | å¼ºï¼ˆé¢„å®šä¹‰æµç¨‹ï¼‰ | **ä¸­ï¼ˆé æ¨¡å‹æ¨ç†ï¼‰** | ä¸­ï¼ˆå¯åŠ çº¦æŸï¼‰ |
| **æ‰©å±•æ–¹å¼** | æ³¨å†Œæ–° tool å‡½æ•° | æ·»åŠ æ–° node/edge | **æ·»åŠ  SKILL.md æ–‡ä»¶** | æ·»åŠ æ–° agent |
| **é€‚ç”¨åœºæ™¯** | RAG + tool æ··åˆ | ç”Ÿäº§çº§/ä¼ä¸š | **coding agent/ä¸ªäºº agent** | ç ”ç©¶/å¤šè§’è‰²è¾©è®º |

### Skill First çš„ä¼˜åŠ¿

1. **é›¶ä»£ç æ‰©å±•** â€” æ·»åŠ èƒ½åŠ›åªéœ€å†™ä¸€ä¸ª Markdown æ–‡ä»¶
2. **Token é«˜æ•ˆ** â€” Skill å†…å®¹åˆ©ç”¨ prompt cachingï¼Œæˆæœ¬é™ä½ 80%+
3. **çŸ¥è¯†é©±åŠ¨** â€” ä¸ä»…æè¿°"èƒ½åšä»€ä¹ˆ"ï¼Œè¿˜æ•™ä¼šæ¨¡å‹"æ€ä¹ˆåš"å’Œ"æœ€ä½³å®è·µ"
4. **çƒ­é‡è½½** â€” ä¿®æ”¹ SKILL.md æ–‡ä»¶å 250ms å†…è‡ªåŠ¨ç”Ÿæ•ˆ
5. **è‡ªç„¶ç»„åˆ** â€” æ¨¡å‹æ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨é€‰æ‹©å’Œç»„åˆå¤šä¸ª Skills
6. **æ¸è¿›å¢å¼º** â€” ä»å•ä¸ª SKILL.md åˆ°å®Œæ•´ç›®å½•ï¼ˆå«è¾…åŠ©æ–‡ä»¶/è„šæœ¬ï¼‰ï¼Œèƒ½åŠ›å¯æ¸è¿›æ‰©å±•

### Skill First çš„æƒè¡¡

1. **å¯æ§æ€§å¼±äº Workflow** â€” æ¨¡å‹è‡ªè¡Œå†³å®šä½¿ç”¨è·¯å¾„
2. **ä¾èµ–æ¨¡å‹èƒ½åŠ›** â€” éœ€è¦ Claude/GPT-4 çº§åˆ«çš„å¼ºæ¨ç†æ¨¡å‹
3. **è°ƒè¯•ä¸é€æ˜** â€” æ¨¡å‹çš„ Skill é€‰æ‹©å’Œç»„åˆé€»è¾‘éšå«åœ¨æ¨ç†ä¸­
4. **éç¡®å®šæ€§** â€” åŒæ ·çš„è¾“å…¥å¯èƒ½äº§ç”Ÿä¸åŒçš„æ‰§è¡Œè·¯å¾„

---

## 8. å­¦ä¹ è·¯çº¿å›¾

### æŒ‰æ¨¡å—é˜…è¯»é¡ºåº

```
ç¬¬ 1 å±‚: æ ¸å¿ƒæ¦‚å¿µ (ç†è§£ Skill First å“²å­¦)
â”œâ”€ models.py              â†’ Skill æ•°æ®æ¨¡å‹
â”œâ”€ config.py              â†’ é…ç½®ç»“æ„
â””â”€ loaders/markdown.py    â†’ Skill æ–‡ä»¶è§£æ

ç¬¬ 2 å±‚: å¼•æ“ç®¡çº¿ (ç†è§£åŠ è½½â†’è¿‡æ»¤â†’è¿è¡Œ)
â”œâ”€ engine.py              â†’ æ ¸å¿ƒå¼•æ“ç¼–æ’
â”œâ”€ filters/default.py     â†’ èµ„æ ¼æ£€æŸ¥é€»è¾‘
â””â”€ runtime/bash.py        â†’ å‘½ä»¤æ‰§è¡Œå¼•æ“

ç¬¬ 3 å±‚: Agent è¿è¡Œæ—¶ (ç†è§£ ReAct Loop)
â”œâ”€ agent.py               â†’ AgentRunner å®Œæ•´å®ç°
â”œâ”€ events.py              â†’ äº‹ä»¶æ€»çº¿å’Œæ•°æ®ç±»
â””â”€ context.py             â†’ ä¸Šä¸‹æ–‡çª—å£ç®¡ç†

ç¬¬ 4 å±‚: é€‚é…ä¸æ‰©å±• (ç†è§£å¯æ’æ‹”è®¾è®¡)
â”œâ”€ adapters/base.py       â†’ LLM é€‚é…å™¨æŠ½è±¡
â”œâ”€ adapters/anthropic.py  â†’ Anthropic å®ç°
â”œâ”€ adapters/transform.py  â†’ è·¨æä¾›å•†æ¶ˆæ¯è½¬æ¢
â””â”€ cache.py               â†’ Prompt ç¼“å­˜ç­–ç•¥

ç¬¬ 5 å±‚: å¤–éƒ¨ä½“ç³» (ç†è§£å®Œæ•´ç”Ÿæ€)
â”œâ”€ memory/                â†’ è·¨ä¼šè¯è®°å¿†
â”œâ”€ session/               â†’ ä¼šè¯æŒä¹…åŒ– + åˆ†æ”¯
â”œâ”€ packages/              â†’ åŒ…ç®¡ç†å’Œå‘ç°
â”œâ”€ tools/                 â†’ æ‰©å±•å·¥å…·é›†
â”œâ”€ tui/                   â†’ ç»ˆç«¯ UI æ¡†æ¶
â””â”€ web/                   â†’ Web UI åç«¯

ç¬¬ 6 å±‚: å…¥å£ä¸é›†æˆ
â”œâ”€ cli.py                 â†’ CLI å‘½ä»¤å…¥å£
â”œâ”€ modes/                 â†’ è¿è¡Œæ¨¡å¼ (interactive/json/rpc)
â””â”€ context_files.py       â†’ AGENTS.md / CLAUDE.md å‘ç°
```

### å…³é”®æ–‡ä»¶è¡Œæ•°å‚è€ƒ

| æ–‡ä»¶ | è¡Œæ•° | å¤æ‚åº¦ | æ ¸å¿ƒä»·å€¼ |
|------|------|--------|---------|
| `agent.py` | ~1100 | é«˜ | Agent å®Œæ•´å¾ªç¯ + æµå¼ + å·¥å…·æ‰§è¡Œ |
| `engine.py` | ~600 | ä¸­ | åŠ è½½ç®¡çº¿ + ç¯å¢ƒç®¡ç† + æ–‡ä»¶ç›‘å¬ |
| `events.py` | ~350 | ä¸­ | ç±»å‹åŒ–äº‹ä»¶ + EventBus |
| `models.py` | ~200 | ä½ | æ‰€æœ‰æ•°æ®ç»“æ„ |
| `runtime/bash.py` | ~250 | ä¸­ | åŒè·¯å¾„æ‰§è¡Œ + ä¸­æ­¢ + æµå¼ |
| `adapters/anthropic.py` | ~200 | ä¸­ | Anthropic ç‰¹æ€§ (thinking, cache) |
| `session/manager.py` | ~200 | ä¸­ | JSONL æŒä¹…åŒ– + åˆ†æ”¯ |
| `memory/hooks.py` | ~100 | ä½ | é€æ˜è®°å¿†ç®¡ç† |

---

> **æ€»ç»“**ï¼šSkillKit ä»£è¡¨äº†ä¸€ç§ä»¥ **"çŸ¥è¯†æ³¨å…¥"æ›¿ä»£"å·¥å…·å †ç Œ"** çš„ Agent è®¾è®¡å“²å­¦ã€‚å®ƒé€šè¿‡ Markdown ç›®å½•å®šä¹‰æŠ€èƒ½ã€æå°‘çš„å†…ç½®åŸè¯­å·¥å…·ã€äº‹ä»¶é©±åŠ¨çš„ Hooks ç”Ÿå‘½å‘¨æœŸã€å¯æ’æ‹”çš„å››å±‚å­ç³»ç»Ÿï¼ˆLoader / Filter / Runtime / Adapterï¼‰ã€ä»¥åŠ MCP/Extension æ‰©å±•æœºåˆ¶ï¼Œæ„å»ºäº†ä¸€ä¸ªæç®€ä½†åŠŸèƒ½å®Œå¤‡çš„ Agent è¿è¡Œæ—¶ã€‚
>
> åœ¨ "Skills are new software, Agents are new OS" çš„èŒƒå¼ä¸‹ï¼ŒSkillKit å±•ç¤ºäº†ä¸ªäºº Agent å­¦ä¹ é¡¹ç›®çš„ç†æƒ³æ¶æ„ â€” è¶³å¤Ÿç®€å•å¯ä»¥å®Œå…¨ç†è§£ï¼Œè¶³å¤Ÿå®Œæ•´å¯ä»¥çœŸæ­£ä½¿ç”¨ã€‚

---

## 9. ä¸‰æ­¥å®ç°è·¯çº¿å›¾ï¼ˆPhase 1 â†’ Phase 2 â†’ Phase 3ï¼‰

å¦‚æœè¦ä»é›¶å®ç°è¿™å¥—ç³»ç»Ÿï¼Œå¯ä»¥åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½èƒ½ç‹¬ç«‹è¿è¡Œå’ŒéªŒè¯ã€‚

---

### Phase 1: æœ€å°å¯ç”¨å¼•æ“ â€” Skills Engine Core

> **ç›®æ ‡**ï¼šå®ç° Skill çš„å®šä¹‰ â†’ åŠ è½½ â†’ è¿‡æ»¤ â†’ Prompt ç”Ÿæˆ â†’ Bash æ‰§è¡Œ
> **æ ¸å¿ƒæ–‡ä»¶**ï¼šmodels.py, config.py, engine.py, loaders/, filters/, runtime/bash.py

```
Phase 1 æ¶æ„:

SKILL.md â”€â”€â†’ [MarkdownSkillLoader] â”€â”€â†’ [DefaultSkillFilter] â”€â”€â†’ SkillSnapshot
                                                                      â”‚
                                                              format_prompt()
                                                                      â”‚
                                                                      â–¼
ç”¨æˆ· â”€â”€â†’ æ‰‹åŠ¨æ‹¼æ¥ System Prompt + Skills Prompt â”€â”€â†’ ä»»æ„ LLM API
                                                         â”‚
                                                    tool_call: execute
                                                         â”‚
                                                         â–¼
                                                   [BashRuntime]
                                                    æ‰§è¡Œ CLI å‘½ä»¤
```

#### Phase 1 å®ç°æ¸…å•

| æ­¥éª¤ | æ¨¡å— | è¦å®ç°çš„å†…å®¹ | éªŒè¯æ ‡å‡† |
|------|------|------------|---------|
| 1.1 | **models.py** | `Skill`, `SkillMetadata`, `SkillRequirements`, `SkillSnapshot`, `SkillSource` æ•°æ®ç±» | èƒ½åˆ›å»º Skill å®ä¾‹å¹¶åºåˆ—åŒ– |
| 1.2 | **config.py** | `SkillsConfig`, `SkillEntryConfig`ï¼›æ”¯æŒ YAML åŠ è½½ | èƒ½ä» YAML æ–‡ä»¶åŠ è½½é…ç½® |
| 1.3 | **loaders/markdown.py** | `MarkdownSkillLoader`ï¼šè§£æ YAML frontmatter + Markdown body | ç»™å®š SKILL.md æ–‡ä»¶ï¼Œèƒ½è§£æå‡ºå®Œæ•´ Skill å¯¹è±¡ |
| 1.4 | **filters/default.py** | `DefaultSkillFilter`ï¼š9 çº§çŸ­è·¯æ£€æŸ¥ï¼ˆOS/bins/env/configï¼‰ | èƒ½æ ¹æ®å½“å‰ç¯å¢ƒæ­£ç¡®ç­›é€‰å‡ºåˆæ ¼çš„ Skills |
| 1.5 | **runtime/bash.py** | `BashRuntime`ï¼šsubprocess æ‰§è¡Œ + è¶…æ—¶ + è¾“å‡ºæ”¶é›† | èƒ½æ‰§è¡Œ bash å‘½ä»¤å¹¶è¿”å› `ExecutionResult` |
| 1.6 | **engine.py** | `SkillsEngine`ï¼šç»„è£…ç®¡çº¿ loadâ†’filterâ†’formatâ†’snapshot | è°ƒç”¨ `get_snapshot()` èƒ½è¿”å›å®Œæ•´çš„ SkillSnapshot |
| 1.7 | **CLI** | `skills list` / `skills show <name>` / `skills exec <cmd>` åŸºæœ¬å‘½ä»¤ | å‘½ä»¤è¡Œå¯åˆ—å‡ºã€æŸ¥çœ‹ã€æ‰§è¡Œ Skills |

#### Phase 1 ç¤ºä¾‹ä»£ç 

```python
# Phase 1 å®Œæˆåå¯ä»¥è¿™æ ·ä½¿ç”¨:
from agent_skills_engine import SkillsEngine, SkillsConfig

config = SkillsConfig(skill_dirs=[Path("./skills")])
engine = SkillsEngine(config)

# åŠ è½½å¹¶è¿‡æ»¤æŠ€èƒ½
snapshot = engine.get_snapshot()
print(f"åˆæ ¼æŠ€èƒ½: {snapshot.skill_names}")   # ['github', 'python']
print(f"Prompt:\n{snapshot.prompt}")          # <skills>...</skills>

# æ‰§è¡Œå‘½ä»¤
result = await engine.execute("gh issue list --limit 5")
print(result.output)
```

#### Phase 1 æ”¶è·

- ç†è§£ Skill å®šä¹‰æ ¼å¼å’Œæ•°æ®æ¨¡å‹
- æŒæ¡ç®¡çº¿ï¼ˆPipelineï¼‰æ¨¡å¼ï¼šLoad â†’ Filter â†’ Format
- æŒæ¡çŸ­è·¯è¿‡æ»¤å’Œç¯å¢ƒæ£€æµ‹
- æŒæ¡ async subprocess æ‰§è¡Œ

---

### Phase 2: Agent è¿è¡Œæ—¶ â€” ReAct Loop + Event System

> **ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„ Agent å¾ªç¯ï¼ˆLLM è°ƒç”¨ â†’ å·¥å…·æ‰§è¡Œ â†’ å¤šè½®è¿­ä»£ï¼‰ï¼ŒåŠ å…¥äº‹ä»¶ç³»ç»Ÿ
> **æ ¸å¿ƒæ–‡ä»¶**ï¼šagent.py, events.py, context.py, adapters/, cache.py

```
Phase 2 æ¶æ„:

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            AgentRunner                    â”‚
                    â”‚                                         â”‚
ç”¨æˆ·è¾“å…¥ â”€â”€â†’        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚  â”‚ EventBus  â”‚    â”‚ContextManager  â”‚    â”‚
                    â”‚  â”‚ (12 äº‹ä»¶) â”‚    â”‚ (Token é¢„ç®—)   â”‚    â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â”‚                                         â”‚
                    â”‚  Agent Loop:                            â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ 1. build_system_prompt()         â”‚   â”‚
                    â”‚  â”‚ 2. _call_llm() [OpenAI/Anthropic]â”‚  â”‚
                    â”‚  â”‚ 3. _execute_tool() [BashRuntime] â”‚   â”‚
                    â”‚  â”‚ 4. æ£€æŸ¥ tool_calls â†’ å¾ªç¯/é€€å‡º   â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                                         â”‚
                    â”‚  SkillsEngine (Phase 1)                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Phase 2 å®ç°æ¸…å•

| æ­¥éª¤ | æ¨¡å— | è¦å®ç°çš„å†…å®¹ | éªŒè¯æ ‡å‡† |
|------|------|------------|---------|
| 2.1 | **events.py** | `EventBus` ç±» + 12 ä¸ªäº‹ä»¶æ•°æ®ç±»ï¼›æ”¯æŒ sync/async handlerï¼Œpriority æ’åº | äº‹ä»¶æ³¨å†Œ â†’ è§¦å‘ â†’ handler æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œ |
| 2.2 | **context.py** | `ContextManager` + `TokenBudgetCompactor` + `SlidingWindowCompactor` | æ¶ˆæ¯è¶…è¿‡é˜ˆå€¼æ—¶èƒ½è‡ªåŠ¨å‹ç¼© |
| 2.3 | **adapters/base.py** | `LLMAdapter` æŠ½è±¡ç±» + `Message`, `AgentResponse`, `ToolDefinition` | å®šä¹‰ç»Ÿä¸€çš„ LLM æ¥å£ |
| 2.4 | **adapters/openai (å†…ç½®)** | é€šè¿‡ openai SDK å®ç° `chat()` å’Œ `chat_stream()`ï¼›è¿”å› tool_calls | èƒ½è°ƒç”¨ OpenAI å…¼å®¹ API å¹¶è§£æ tool_calls |
| 2.5 | **adapters/anthropic.py** | `AnthropicAdapter`ï¼šthinking budget, cache_control, streaming events | èƒ½è°ƒç”¨ Claude API å¹¶å¤„ç† thinking blocks |
| 2.6 | **adapters/transform.py** | `transform_messages()`ï¼štool_call ID å½’ä¸€åŒ–ã€thinking block è½¬æ¢ã€å­¤ç«‹ tool_call ä¿®å¤ | æ¶ˆæ¯åœ¨ OpenAI â†” Anthropic é—´æ— æŸè½¬æ¢ |
| 2.7 | **cache.py** | `get_cache_control_anthropic()`, `get_cache_config_openai()` | Prompt caching æ­£ç¡®é…ç½® |
| 2.8 | **agent.py** | `AgentRunner`ï¼šReAct loop, `chat()`, `chat_stream()`, `chat_stream_events()`, abort/steer/follow_up | èƒ½å¤šè½®å·¥å…·è°ƒç”¨è‡ªåŠ¨æ‰§è¡Œå¹¶è¿”å›æœ€ç»ˆç»“æœ |
| 2.9 | **context_files.py** | `load_context_files()`ï¼šå‘ä¸Šéå†å‘ç° AGENTS.md/CLAUDE.md | èƒ½è‡ªåŠ¨å‘ç°å¹¶æ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡ |

#### Phase 2 ç¤ºä¾‹ä»£ç 

```python
# Phase 2 å®Œæˆåå¯ä»¥è¿™æ ·ä½¿ç”¨:
from agent_skills_engine import create_agent, BEFORE_TOOL_CALL

agent = await create_agent(
    skill_dirs=[Path("./skills")],
    system_prompt="You are a helpful assistant.",
    model="claude-sonnet-4-20250514",
)

# æ³¨å†Œå®‰å…¨é’©å­
@agent.events.on(BEFORE_TOOL_CALL, priority=0)
async def guard(event):
    if "rm -rf" in event.args.get("command", ""):
        return ToolCallEventResult(block=True, reason="Blocked")

# åŒæ­¥å¯¹è¯
response = await agent.chat("å¸®æˆ‘æŸ¥çœ‹æœ€è¿‘çš„ GitHub Issues")
print(response.content)

# æµå¼å¯¹è¯
async for event in agent.chat_stream_events("é‡æ„ auth æ¨¡å—"):
    if event.type == "text_delta":
        print(event.content, end="")
    elif event.type == "tool_call_start":
        print(f"\n[è°ƒç”¨å·¥å…·: {event.tool_name}]")

# ä¸­æ­¢é•¿æ—¶é—´æ“ä½œ
agent.abort()
```

#### Phase 2 æ”¶è·

- ç†è§£ ReAct Loopï¼ˆobserveâ†’thinkâ†’actâ†’learnâ†’repeatï¼‰
- æŒæ¡ EventBus äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆå‘å¸ƒ/è®¢é˜… + æ‹¦æˆª/ä¿®æ”¹ï¼‰
- æŒæ¡ LLM streaming + function calling çš„å®Œæ•´æµç¨‹
- æŒæ¡è·¨ LLM æä¾›å•†çš„æ¶ˆæ¯æ ¼å¼é€‚é…
- ç†è§£ä¸Šä¸‹æ–‡çª—å£ç®¡ç†å’Œå‹ç¼©ç­–ç•¥

---

### Phase 3: å®Œæ•´ç”Ÿæ€ â€” Memory + Session + Extension + TUI

> **ç›®æ ‡**ï¼šæ¥å…¥æŒä¹…åŒ–è®°å¿†ã€ä¼šè¯ç®¡ç†ã€æ’ä»¶ç³»ç»Ÿã€ç»ˆç«¯ç•Œé¢ï¼Œå½¢æˆå®Œæ•´å¯ç”¨çš„ Agent äº§å“
> **æ ¸å¿ƒæ–‡ä»¶**ï¼šmemory/, session/, packages/, tools/, tui/, web/, modes/

```
Phase 3 æ¶æ„:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®Œæ•´äº§å“å½¢æ€                                    â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  ç”¨æˆ·äº¤äº’å±‚           â”‚                                           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”â”‚                                           â”‚
â”‚  â”‚  â”‚ TUI â”‚ â”‚Web â”‚ â”‚RPCâ”‚â”‚                                           â”‚
â”‚  â”‚  â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”€â”¬â”€â”˜â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜                                           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚               â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           AgentRunner (Phase 2)                                â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ New in Phase 3:                                      â”‚     â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  Memory System          Session Manager              â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ OpenVikingClient    â”œâ”€ JSONL Store              â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ 4 Memory Tools      â”œâ”€ Tree Structure           â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ 3 Lifecycle Hooks   â””â”€ Fork / Navigate          â”‚     â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  Extension System        Package Manager             â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ ToolInfo Registry    â”œâ”€ local/pypi/git Sources  â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ CommandInfo          â”œâ”€ pyproject.toml Manifest  â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ExtensionAPI         â””â”€ Auto-discovery           â”‚     â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  TUI Framework           Theme System                â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Diff Renderer        â”œâ”€ 53 Color Keys           â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input/Editor         â”œâ”€ Variable Resolution      â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Autocomplete         â””â”€ JSON + Discovery         â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Keybindings                                      â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  SkillsEngine (Phase 1)                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Phase 3 å®ç°æ¸…å•

| æ­¥éª¤ | æ¨¡å— | è¦å®ç°çš„å†…å®¹ | éªŒè¯æ ‡å‡† |
|------|------|------------|---------|
| **3.1 Session** | | | |
| 3.1a | session/models.py | 8 ç§æ¡ç›®ç±»å‹ + `SessionContext` | èƒ½è¡¨ç¤ºå®Œæ•´å¯¹è¯çŠ¶æ€ |
| 3.1b | session/store.py | JSONL è¯»å†™ + `list_sessions()` | å¯¹è¯å¯æŒä¹…åŒ–åˆ°æ–‡ä»¶ |
| 3.1c | session/tree.py | `build_tree()`, `get_branches()`, `walk_to_root()` | å¯¹è¯æ ‘å¯æ­£ç¡®æ„å»ºå’Œéå† |
| 3.1d | session/manager.py | `SessionManager`ï¼šappend, build_context, fork, navigate | æ”¯æŒåˆ†æ”¯å’Œå›æº¯ |
| **3.2 Memory** | | | |
| 3.2a | memory/client.py | `OpenVikingClient`ï¼šHTTP å°è£… (create_session, add_message, find, commit) | èƒ½ä¸ OpenViking æœåŠ¡å™¨é€šä¿¡ |
| 3.2b | memory/tools.py | 4 ä¸ª Memory Tools (recall/save/explore/knowledge) | LLM èƒ½é€šè¿‡ function calling æ“ä½œè®°å¿† |
| 3.2c | memory/hooks.py | 3 ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¢é‡åŒæ­¥ + è‡ªåŠ¨ commitï¼‰ | Agent ç»“æŸåè®°å¿†è‡ªåŠ¨ä¿å­˜ |
| 3.2d | memory/extension.py | `setup_memory()` ä¸€é”®æ¥å…¥å‡½æ•° | ä¸€è¡Œä»£ç æ¥å…¥ Memory ç³»ç»Ÿ |
| **3.3 Extensions** | | | |
| 3.3a | extensions/ | `ExtensionManager`, `ExtensionAPI`, `ToolInfo`, `CommandInfo` | Extension å¯æ³¨å†Œå·¥å…·å’Œå‘½ä»¤ |
| 3.3b | tools/registry.py | `ToolRegistry` + `BaseTool` + 7 ä¸ªå†…ç½®å·¥å…· | Read/Write/Edit/Bash/Find/Grep/Ls å¯ç”¨ |
| **3.4 Packages** | | | |
| 3.4a | packages/ | `PackageManager`ï¼šauto-discover + pyproject.toml manifest | èƒ½ä»å¤šæ¥æºè§£æ Skills/Extensions |
| **3.5 Modes** | | | |
| 3.5a | modes/json_mode.py | JSONL è¾“å‡ºæ¨¡å¼ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰ | ç¨‹åºåŒ–é›†æˆå¯ç”¨ |
| 3.5b | modes/rpc_mode.py | stdin/stdout JSON-RPC åè®® | å¤–éƒ¨ç¨‹åºå¯é€šè¿‡ RPC æ§åˆ¶ Agent |
| 3.5c | modes/interactive.py | Rich-based äº¤äº’æ¨¡å¼ | ç»ˆç«¯äº¤äº’å¯ç”¨ |
| **3.6 TUI** | | | |
| 3.6a | tui/renderer.py | å·®åˆ†æ¸²æŸ“å¼•æ“ | åªé‡ç»˜å˜åŒ–è¡Œï¼Œæ— é—ªçƒ |
| 3.6b | tui/input_widget.py | å•è¡Œè¾“å…¥ + readline å¿«æ·é”® | æ”¯æŒ Ctrl+A/E/K/U/W ç­‰ |
| 3.6c | tui/editor_widget.py | å¤šè¡Œç¼–è¾‘å™¨ + è‡ªåŠ¨æ¢è¡Œ | æ”¯æŒ Tab/PgUp/PgDn/Ctrl+Enter |
| 3.6d | tui/autocomplete.py | @æ–‡ä»¶ + /å‘½ä»¤ è‡ªåŠ¨è¡¥å…¨ | Tab è¡¥å…¨å¯ç”¨ |
| 3.6e | tui/theme/ | 53 é¢œè‰²é”® + JSON å˜é‡è§£æ + å‘ç° | è‡ªå®šä¹‰ä¸»é¢˜å¯åŠ è½½ |
| 3.6f | tui/keybindings.py | å¿«æ·é”®ç®¡ç† + ~/.skillkit/keybindings.json | å¿«æ·é”®å¯è‡ªå®šä¹‰ |
| **3.7 Web** | | | |
| 3.7a | web/server.py | Starlette + SSE + WebSocket | Web UI å¯ç”¨ |
| 3.7b | web/storage.py | SQLite æŒä¹…åŒ– | Web ä¼šè¯å¯ä¿å­˜ |

#### Phase 3 ç¤ºä¾‹ä»£ç 

```python
# Phase 3 å®Œæˆåçš„å®Œæ•´äº§å“å½¢æ€:

from agent_skills_engine import create_agent, MemoryConfig, setup_memory

# 1. åˆ›å»º Agent
agent = await create_agent(
    skill_dirs=[Path("~/.skillkit/skills"), Path("./skills")],
    system_prompt="You are Alex's personal coding assistant.",
    model="claude-sonnet-4-20250514",
    watch_skills=True,        # çƒ­é‡è½½
    cache_retention="long",   # é•¿ç¼“å­˜
)

# 2. æ¥å…¥ Memory
await setup_memory(agent, MemoryConfig(auto_session=True, auto_commit=True))

# 3. æ¥å…¥ Session æŒä¹…åŒ–
from agent_skills_engine.session import SessionManager
agent.session = SessionManager(session_dir=Path("~/.skillkit/sessions"))

# 4. è¿è¡Œäº¤äº’æ¨¡å¼
from agent_skills_engine.modes import InteractiveMode
mode = InteractiveMode(agent)
await mode.run()  # è¿›å…¥ TUI äº¤äº’ç•Œé¢

# æˆ–è€…è¿è¡Œ Web UI
from agent_skills_engine.web import run_server
await run_server(agent, port=8080)

# æˆ–è€… CLI å•æ¬¡è°ƒç”¨
from agent_skills_engine.modes import JsonMode
mode = JsonMode(agent)
await mode.run("å¸®æˆ‘éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬åˆ° staging")
```

#### Phase 3 æ”¶è·

- æŒæ¡è·¨ä¼šè¯è®°å¿†çš„é€æ˜é›†æˆæ¨¡å¼ï¼ˆEventBus hooksï¼‰
- ç†è§£ JSONL append-only å­˜å‚¨ + å¯¹è¯æ ‘åˆ†æ”¯
- æŒæ¡ Extension/Plugin ç³»ç»Ÿè®¾è®¡
- ç†è§£åŒ…å‘ç°å’Œè§£ææœºåˆ¶
- æŒæ¡ç»ˆç«¯ UI å·®åˆ†æ¸²æŸ“å’Œè¾“å…¥å¤„ç†
- ç†è§£ SSE/WebSocket å®æ—¶é€šä¿¡

---

### ä¸‰é˜¶æ®µæ€»ç»“å¯¹ç…§

```
Phase 1: Skills Engine Core          Phase 2: Agent Runtime            Phase 3: å®Œæ•´ç”Ÿæ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
models.py                            events.py                         memory/
config.py                            context.py                        session/
loaders/                             agent.py                          packages/
filters/                             adapters/                         tools/
runtime/bash.py                      cache.py                          tui/
engine.py                            context_files.py                  web/
cli.py (åŸºæœ¬å‘½ä»¤)                    cli.py (chat å‘½ä»¤)                modes/
                                                                       themes/

äº¤ä»˜ç‰©:                              äº¤ä»˜ç‰©:                           äº¤ä»˜ç‰©:
âœ… skills list/show/exec             âœ… å®Œæ•´ ReAct Loop                âœ… æŒä¹…åŒ–è®°å¿†
âœ… Prompt ç”Ÿæˆ                       âœ… å¤šè½®å·¥å…·è°ƒç”¨                   âœ… ä¼šè¯åˆ†æ”¯
âœ… Bash æ‰§è¡Œ                         âœ… æµå¼å“åº”                       âœ… æ’ä»¶ç³»ç»Ÿ
âœ… Skill è¿‡æ»¤                        âœ… äº‹ä»¶é’©å­                       âœ… åŒ…ç®¡ç†
                                     âœ… è·¨æ¨¡å‹é€‚é…                    âœ… TUI + Web UI
                                     âœ… ä¸Šä¸‹æ–‡å‹ç¼©                    âœ… ä¸»é¢˜ + å¿«æ·é”®

å¤æ‚åº¦: â˜…â˜…â˜†â˜†â˜†                      å¤æ‚åº¦: â˜…â˜…â˜…â˜…â˜†                   å¤æ‚åº¦: â˜…â˜…â˜…â˜…â˜…
è€—æ—¶: 1-2 å‘¨                        è€—æ—¶: 2-3 å‘¨                     è€—æ—¶: 3-4 å‘¨
ä»£ç é‡: ~1500 è¡Œ                    ä»£ç é‡: ~3000 è¡Œ                 ä»£ç é‡: ~5000 è¡Œ
```

**æ¯ä¸ª Phase éƒ½æ˜¯å®Œæ•´å¯ç”¨çš„**ï¼š
- Phase 1 å®Œæˆåï¼šå¯ä»¥é€šè¿‡ CLI ç®¡ç† Skillsï¼Œæ‰‹åŠ¨æ‹¼æ¥ Prompt è°ƒç”¨ LLM
- Phase 2 å®Œæˆåï¼šå¯ä»¥é€šè¿‡ä»£ç å®ç°è‡ªåŠ¨åŒ–çš„ Agent å¯¹è¯ï¼ˆå·²æ˜¯ä¸€ä¸ªå®Œæ•´çš„ coding agentï¼‰
- Phase 3 å®Œæˆåï¼šå¯ä»¥ä½œä¸ºæ—¥å¸¸ä½¿ç”¨çš„ä¸ªäºº Agent äº§å“ï¼ˆTUI/Web/è®°å¿†/ä¼šè¯ï¼‰
